name: gemini ai discord greeting

on:
  schedule:
    - cron: '0 0 * * 1-5'    # 7 AM WIB weekdays
    - cron: '0 5 * * 1-5'    # 12 PM WIB weekdays  
    - cron: '0 10 * * 1-5'   # 5 PM WIB weekdays
    - cron: '0 15 * * 1-5'   # 10 PM WIB weekdays
    - cron: '0 0 * * 6,0'    # 7 AM WIB weekends
    - cron: '0 5 * * 6,0'    # 12 PM WIB weekends
    - cron: '0 10 * * 6,0'   # 5 PM WIB weekends
    - cron: '0 15 * * 6,0'   # 10 PM WIB weekends
  workflow_dispatch:
    inputs:
      greeting_type:
        description: 'select greeting type'
        required: true
        default: 'morning'
        type: choice
        options: [morning, afternoon, evening, night]

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Send Gemini AI Greeting
        run: |
          set -e
          
          # Determine greeting type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ github.event.inputs.greeting_type }}"
          else
            case "${{ github.event.schedule }}" in
              "0 0 * * 1-5"|"0 0 * * 6,0") TYPE="morning" ;;
              "0 5 * * 1-5"|"0 5 * * 6,0") TYPE="afternoon" ;;
              "0 10 * * 1-5"|"0 10 * * 6,0") TYPE="evening" ;;
              "0 15 * * 1-5"|"0 15 * * 6,0") TYPE="night" ;;
            esac
          fi
          
          # Check if weekend
          DAY=$(date +%u)
          if [[ $DAY -eq 6 || $DAY -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          echo "ðŸ¤– Generating greeting: $TYPE ($CONTEXT)"
          
          # Natural eng-indo mix prompt
          read -r -d '' PROMPT << 'EOF' || true
          Buatkan greeting Discord untuk waktu TYPE_PLACEHOLDER hari CONTEXT_PLACEHOLDER.

          Style: Natural mix English-Indonesian slang yang flow, ga kaku, casual banget
          - English slang: "yo", "what's good", "fr", "no cap", "lowkey", "bet", "periodt", "it's giving"
          - Indo slang natural: "woy", "anjir", "kocak", "gas", "santuy", "gabut", "bucin", "anying"
          - Gaming terms: "rank", "mabar", "noob", "gg", "afk", "respawn", "main character energy"
          - Badword chill: "anjir", "anying", "kampret" (yang wajar aja)

          Buat yang NATURAL, jangan forced. Contoh flow bagus:
          "yo what's good fam! malem jumat nih perfect buat mabar bareng, jangan pada afk terus anjir ðŸ˜‚"

          Format output EXACT:
          TITLE: [mix eng-indo natural dengan emoji]
          DESC: [1-2 kalimat yang flow natural, ga kaku]
          > by server dev - <@399393175904714752>
          FOOTER: [footer pendek yang relate]

          PENTING: Bikin yang relate sama waktu dan hari, jangan generic!
          EOF
          
          # Replace placeholders
          PROMPT=${PROMPT//TYPE_PLACEHOLDER/$TYPE}
          PROMPT=${PROMPT//CONTEXT_PLACEHOLDER/$CONTEXT}
          
          # Try Gemini API (with proper error handling) - Updated to gemini-2.5-flash-lite
          GEMINI_RESPONSE=""
          if curl -f -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{\"text\": \"$PROMPT\"}]
              }],
              \"generationConfig\": {
                \"temperature\": 0.8,
                \"maxOutputTokens\": 200
              }
            }" \
            --connect-timeout 10 --max-time 15 > /tmp/gemini_response.json 2>/dev/null; then
            
            # Parse response
            if AI_TEXT=$(jq -r '.candidates[0].content.parts[0].text' /tmp/gemini_response.json 2>/dev/null); then
              echo "âœ… Gemini API success"
              echo "$AI_TEXT" > /tmp/ai_content.txt
              
              # Extract parts with simple parsing
              TITLE=$(echo "$AI_TEXT" | grep -i "TITLE:" | head -1 | sed 's/.*TITLE:[[:space:]]*//' | sed 's/^[[:space:]]*//')
              FOOTER=$(echo "$AI_TEXT" | grep -i "FOOTER:" | head -1 | sed 's/.*FOOTER:[[:space:]]*//' | sed 's/^[[:space:]]*//')
              
              # Get DESC (everything between TITLE and "> by server dev")
              DESC=$(echo "$AI_TEXT" | sed -n '/TITLE:/,/> by server dev/p' | grep -v "TITLE:" | grep -v "FOOTER:" | sed '/> by server dev/d' | tr '\n' ' ' | sed 's/DESC:[[:space:]]*//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # Add the required ending
              if [[ -n "$DESC" ]]; then
                DESC="$DESC\\n> by server dev - <@399393175904714752>"
              fi
              
              # Validate
              if [[ -n "$TITLE" && -n "$DESC" && -n "$FOOTER" ]]; then
                echo "âœ… Parsing successful"
                echo "Title: $TITLE"
                echo "Footer: $FOOTER"
                USE_AI=true
              else
                echo "âŒ Parsing failed, using fallback"
                USE_AI=false
              fi
            else
              echo "âŒ JSON parsing failed"
              USE_AI=false
            fi
          else
            echo "âŒ Gemini API call failed"
            USE_AI=false
          fi
          
          # Fallback messages if AI fails
          if [[ "$USE_AI" != "true" ]]; then
            echo "ðŸŽ² Using fallback greeting"
            INDEX=$((RANDOM % 3))
            
            case "$TYPE-$INDEX" in
              "morning-0")
                TITLE="ðŸŒ„ pagi woy, gas tipis aja"
                DESC="yo morning fam! jangan jadi NPC parkir di base, gerak dikit udah win fr ðŸ˜‚\\n> by server dev - <@399393175904714752>"
                FOOTER="santai tapi jalan"
                ;;
              "morning-1")
                TITLE="ðŸŒ… bangun santuy, hidup santuy"
                DESC="good morning squad! kopi dulu baru bacot produktif, anying â˜•\\n> by server dev - <@399393175904714752>"
                FOOTER="pelan tapi konsisten"
                ;;
              "morning-2")
                TITLE="â˜€ï¸ morning vibe check"
                DESC="gm legends! MMR turun ga sekejam kata netizen kok, santai kocak ðŸ˜Œ\\n> by server dev - <@399393175904714752>"
                FOOTER="good vibes only"
                ;;
              "afternoon-0")
                TITLE="ðŸŒž siangÂ², break dulu"
                DESC="what's good squad? makan siang itu buff utama, bukan side quest anying ðŸ”\\n> by server dev - <@399393175904714752>"
                FOOTER="recharge mode"
                ;;
              "afternoon-1")
                TITLE="ï¿½ lunch time = sacred time"
                DESC="yo fam! jangan jadi singa di chat, koala di real life ðŸ˜´\\n> by server dev - <@399393175904714752>"
                FOOTER="makan dulu boss"
                ;;
              "afternoon-2")
                TITLE="ðŸ˜Ž tengah hari check"
                DESC="good afternoon gamers! hydrate or diedrate, minum dulu baru war kocak\\n> by server dev - <@399393175904714752>"
                FOOTER="stay hydrated"
                ;;
              "evening-0")
                TITLE="ðŸŒ† sore santai mode"
                DESC="good evening fam! sunset hits different, cooldown bentar biar ga tilt ðŸ˜‚\\n> by server dev - <@399393175904714752>"
                FOOTER="chill vibes"
                ;;
              "evening-1")
                TITLE="ðŸŒ… golden hour energy"
                DESC="evening squad! ganti playlist, cemil dikit, terus lanjut mabar anying\\n> by server dev - <@399393175904714752>"
                FOOTER="malam ini milik kita"
                ;;
              "evening-2")
                TITLE="âœ¨ soreÂ² santai"
                DESC="what's poppin brodie! ketawain aja dikit, hidup tuh ga seseram drama discord fr ðŸ˜Œ\\n> by server dev - <@399393175904714752>"
                FOOTER="santai sejenak"
                ;;
              "night-0")
                TITLE="ðŸŒ™ late night squad, malem weekend"
                DESC="yo what's good night owls! weekend night perfect buat mabar, jangan pada tidur dulu anjir âš¡\\n> by server dev - <@399393175904714752>"
                FOOTER="friday night energy"
                ;;
              "night-1")
                TITLE="ðŸ’¤ bedtime vibes, but weekend tho"
                DESC="gn fam! weekend night hits different, tapi jangan begadang sampai jadi zombie kocak ðŸ˜ª\\n> by server dev - <@399393175904714752>"
                FOOTER="sleep is important too"
                ;;
              "night-2")
                TITLE="ðŸŒœ weekend night check, malem santuy"
                DESC="yo night crew! besok weekend lanjutan, sekarang rest well biar besok fresh anjir\\n> by server dev - <@399393175904714752>"
                FOOTER="weekend continues tomorrow"
                ;;
            esac
          fi
          
          # Set colors and thumbnails
          case "$TYPE" in
            "morning") COLOR=16766720; THUMB="1f305" ;;
            "afternoon") COLOR=16763904; THUMB="2600" ;;
            "evening") COLOR=16744448; THUMB="1f307" ;;
            "night") COLOR=8947848; THUMB="1f319" ;;
          esac
          
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          # Send to Discord
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --connect-timeout 10 --max-time 15 \
               -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"$DESC\",\"color\":$COLOR,\"thumbnail\":{\"url\":\"https://twemoji.maxcdn.com/v/latest/72x72/$THUMB.png\"},\"footer\":{\"text\":\"$FOOTER\",\"icon_url\":\"https://files.catbox.moe/npfh4e.jpg\"},\"timestamp\":\"$TIMESTAMP\"}]}"
          
          echo "âœ… Sent $TYPE greeting (AI: ${USE_AI:-false}, Context: $CONTEXT)"
          
          # Cleanup
          rm -f /tmp/gemini_response.json /tmp/ai_content.txt