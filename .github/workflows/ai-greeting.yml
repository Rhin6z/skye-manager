name: gemini ai discord greeting

on:
  schedule:
    - cron: '0 0 * * 1-5'    # 7 AM WIB weekdays
    - cron: '0 5 * * 1-5'    # 12 PM WIB weekdays  
    - cron: '0 10 * * 1-5'   # 5 PM WIB weekdays
    - cron: '0 15 * * 1-5'   # 10 PM WIB weekdays
    - cron: '0 0 * * 6,0'    # 7 AM WIB weekends
    - cron: '0 5 * * 6,0'    # 12 PM WIB weekends
    - cron: '0 10 * * 6,0'   # 5 PM WIB weekends
    - cron: '0 15 * * 6,0'   # 10 PM WIB weekends
  workflow_dispatch:
    inputs:
      greeting_type:
        description: 'select greeting type'
        required: true
        default: 'morning'
        type: choice
        options: [morning, afternoon, evening, night]

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Send Gemini AI Greeting
        run: |
          set -e
          
          # Determine greeting type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ github.event.inputs.greeting_type }}"
          else
            case "${{ github.event.schedule }}" in
              "0 0 * * 1-5"|"0 0 * * 6,0") TYPE="morning" ;;
              "0 5 * * 1-5"|"0 5 * * 6,0") TYPE="afternoon" ;;
              "0 10 * * 1-5"|"0 10 * * 6,0") TYPE="evening" ;;
              "0 15 * * 1-5"|"0 15 * * 6,0") TYPE="night" ;;
            esac
          fi
          
          # Check if weekend
          DAY=$(date +%u)
          if [[ $DAY -eq 6 || $DAY -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          echo "ðŸ¤– generating greeting: $TYPE ($CONTEXT)"
          
          # Natural eng-indo slang prompt like the good example
          read -r -d '' PROMPT << 'EOF' || true
          Buatin greeting Discord untuk TYPE_PLACEHOLDER hari CONTEXT_PLACEHOLDER yang natural kayak temen chat.

          Style wajib:
          - Casual banget, jangan formal
          - Mix English-Indonesian yang smooth, jangan dipaksa
          - English slang: "what's poppin", "brodie", "fr", "lowkey", "no cap", "periodt", "bet"  
          - Indo casual: "kek", "dikit", "kok", "banget", "anjir", "woy", "cuy", "gabut", "santuy"
          - Gaming/internet: "mmr", "noob", "mabar", "gas", "netizen", "touching grass"
          - Tone: santai, agak sarcastic, relatable
          - Semua lowercase kecuali emoji

          Contoh bagus:
          "ðŸŒƒ jangan sok produktif 24/7, chill dulu kek
          what's poppin brodie! golden hour momentâ€”ketawain aja dikit, mmr turun ga sekejam kata netizen kok fr ðŸ˜Œ"

          Format output:
          TITLE: [casual title dengan emoji, lowercase]
          DESC: [natural sentence yang flow banget, mix eng-indo smooth]
          FOOTER: [footer pendek casual]

          Bikin yang relatable dan ga cringe!
          EOF
          
          # Replace placeholders
          PROMPT=${PROMPT//TYPE_PLACEHOLDER/$TYPE}
          PROMPT=${PROMPT//CONTEXT_PLACEHOLDER/$CONTEXT}
          
          # Try Gemini API with simpler approach
          echo "ðŸ”„ trying gemini api..."
          
          # Check if API key exists
          if [[ -z "${{ secrets.GEMINI_API_KEY }}" ]]; then
            echo "âŒ GEMINI_API_KEY secret is not set"
            USE_AI=false
          else
            echo "âœ… API key is present"
            
            # Try simpler model first (gemini-pro is more stable)
            echo "ðŸ”„ trying gemini-pro model..."
            if RESPONSE=$(curl -s -X POST \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"contents\": [{
                  \"parts\": [{\"text\": \"$PROMPT\"}]
                }],
                \"generationConfig\": {
                  \"temperature\": 0.8,
                  \"maxOutputTokens\": 300
                }
              }" \
              --connect-timeout 15 --max-time 30 2>&1); then
              
              echo "âœ… gemini api call successful"
              echo "Response size: $(echo "$RESPONSE" | wc -c) chars"
              
              # Check for error in response
              if echo "$RESPONSE" | grep -q '"error"'; then
                echo "âŒ gemini api error in response:"
                echo "$RESPONSE" | head -5
                USE_AI=false
              else
                # Try to extract AI text
                if AI_TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null); then
                  if [[ -n "$AI_TEXT" && "$AI_TEXT" != "null" ]]; then
                    echo "âœ… extracted AI response successfully"
                    echo "AI text preview: $(echo "$AI_TEXT" | head -c 100)..."
                    
                    # Simple parsing - look for any content that looks like title/desc
                    TITLE=$(echo "$AI_TEXT" | grep -i "title:" | head -1 | sed 's/.*[Tt][Ii][Tt][Ll][Ee]:[[:space:]]*//' | sed 's/^[[:space:]]*//')
                    DESC_RAW=$(echo "$AI_TEXT" | grep -i "desc:" | head -1 | sed 's/.*[Dd][Ee][Ss][Cc]:[[:space:]]*//' | sed 's/^[[:space:]]*//')
                    FOOTER=$(echo "$AI_TEXT" | grep -i "footer:" | head -1 | sed 's/.*[Ff][Oo][Oo][Tt][Ee][Rr]:[[:space:]]*//' | sed 's/^[[:space:]]*//')
                    
                    # If structured format not found, try to use AI text directly as description
                    if [[ -z "$TITLE" || -z "$DESC_RAW" ]]; then
                      echo "ðŸ”„ structured format not found, using AI text as description"
                      TITLE="ðŸŒ… ai-generated greeting time"
                      DESC_RAW="$AI_TEXT"
                      FOOTER="ai vibes activated"
                    fi
                    
                    # Clean and validate
                    if [[ -n "$TITLE" && -n "$DESC_RAW" ]]; then
                      DESC="$DESC_RAW\\n> by server dev - <@399393175904714752>"
                      echo "âœ… parsing successful"
                      echo "TITLE: $TITLE"
                      echo "DESC length: $(echo "$DESC_RAW" | wc -c) chars"
                      echo "FOOTER: $FOOTER"
                      USE_AI=true
                    else
                      echo "âŒ parsing failed - empty results"
                      USE_AI=false
                    fi
                  else
                    echo "âŒ empty or null AI text"
                    USE_AI=false
                  fi
                else
                  echo "âŒ failed to parse JSON response"
                  echo "Response sample: $(echo "$RESPONSE" | head -c 200)..."
                  USE_AI=false
                fi
              fi
            else
              echo "âŒ gemini api call failed"
              echo "Error: $RESPONSE"
              USE_AI=false
            fi
          fi
          
          # Fallback messages with natural casual style like the good example  
          if [[ "$USE_AI" != "true" ]]; then
            echo "ðŸŽ² using fallback greeting"
            INDEX=$((RANDOM % 3))
            
            case "$TYPE-$INDEX" in
              "morning-0")
                TITLE="ï¿½ bangun dong, pagi udah becall"
                DESC="what's poppin early birds! another day another mmrâ€”eh salah, another dollar kocak ðŸ˜‚\\n> by server dev - <@399393175904714752>"
                FOOTER="caffeine loading"
                ;;
              "morning-1")
                TITLE="â˜€ï¸ jangan jadi zombie pagi-pagi"
                DESC="morning vibes activated fr! kopi dulu baru bisa mikir jernih, ga usah sok produktif langsung anjir â˜•\\n> by server dev - <@399393175904714752>"
                FOOTER="fuel up dulu"
                ;;
              "morning-2")
                TITLE="ðŸŒ„ morning but make it chill"
                DESC="yo brodie what's the plan? pagi $CONTEXT gini perfect buat fresh start, jangan overthink dikit aja kek ðŸŒŸ\\n> by server dev - <@399393175904714752>"
                FOOTER="new day energy"
                ;;
              "afternoon-0")
                TITLE="ï¿½ lunch break is sacred time"
                DESC="midday check! perut udah protes belum? makan siang itu self care juga cuy, jangan skip terus nanti hangry ðŸ˜‹\\n> by server dev - <@399393175904714752>"
                FOOTER="feed yourself bestie"
                ;;
              "afternoon-1")
                TITLE="ï¿½ siang-siang gini ngapain aja"
                DESC="what's good afternoon squad? energy udah mulai drop ya? normal kok, touching grass sebentar atau minum air putih dikit ï¿½\\n> by server dev - <@399393175904714752>"
                FOOTER="recharge time"
                ;;
              "afternoon-2")
                TITLE="ðŸ˜Ž afternoon vibes kinda mid tho"
                DESC="yo afternoon slump is real fr! productivity curve lagi turun, santai aja dulu jangan dipaksa nanti error system ðŸ“‰\\n> by server dev - <@399393175904714752>"
                FOOTER="it's okay to rest"
                ;;
              "evening-0")
                TITLE="ðŸŒ† golden hour tapi masih gabut"
                DESC="what's poppin evening crew! sunset $CONTEXT hits differentâ€”ketawain aja dikit, besok masih ada kok anjir ðŸŒ…\\n> by server dev - <@399393175904714752>"
                FOOTER="chill evening mode"
                ;;
              "evening-1")
                TITLE="âœ¨ jangan sok aesthetic terus"
                DESC="evening vibes lowkey peaceful fr! playlist chill udah ready? time to unwind dikit sebelum malem dateng ðŸŽµ\\n> by server dev - <@399393175904714752>"
                FOOTER="soundtrack your evening"
                ;;
              "evening-2")
                TITLE="ðŸŒ‡ sore-sore reflect dikit"
                DESC="yo how was today brodie? ups and downs normal lah, yang penting masih bisa ketawa sama temen-temen kek gini ðŸ˜Œ\\n> by server dev - <@399393175904714752>"
                FOOTER="you did good today"
                ;;
              "night-0")
                TITLE="ðŸŒ™ malem tapi masih melek"
                DESC="what's good night owls! $CONTEXT night perfect buat santaiâ€”jangan overthink kemarin, besok fresh start lagi kok ðŸŒŸ\\n> by server dev - <@399393175904714752>"
                FOOTER="relax your mind"
                ;;
              "night-1")
                TITLE="ðŸ’¤ bedtime story: rank turun"
                DESC="gn squad! malem $CONTEXT gini perfect buat istirahatâ€”mmr turun ga sekejam kata netizen kok fr ï¿½\\n> by server dev - <@399393175904714752>"
                FOOTER="dreams > rank anxiety"
                ;;
              "night-2")
                TITLE="ðŸŒœ jangan begadang mulu dong"
                DESC="night night brodie! tidur yang bener ya, besok masih ada episode baru kehidupan yang perlu di-tackle kocak ðŸ›Œ\\n> by server dev - <@399393175904714752>"
                FOOTER="sleep is self care"
                ;;
            esac
          fi
          
          # Set colors and thumbnails
          case "$TYPE" in
            "morning") COLOR=16766720; THUMB="1f305" ;;
            "afternoon") COLOR=16763904; THUMB="2600" ;;
            "evening") COLOR=16744448; THUMB="1f307" ;;
            "night") COLOR=8947848; THUMB="1f319" ;;
          esac
          
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          # Send to Discord (simplified like your working code)
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --connect-timeout 10 --max-time 15 \
               -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"$DESC\",\"color\":$COLOR,\"thumbnail\":{\"url\":\"https://twemoji.maxcdn.com/v/latest/72x72/$THUMB.png\"},\"footer\":{\"text\":\"$FOOTER\",\"icon_url\":\"https://files.catbox.moe/npfh4e.jpg\"},\"timestamp\":\"$TIMESTAMP\"}]}"
          
          echo "âœ… sent $TYPE greeting (ai: ${USE_AI:-false}, context: $CONTEXT)"
          
          # Cleanup
          rm -f /tmp/gemini_response.json /tmp/ai_content.txt