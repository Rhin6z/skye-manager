name: gemini ai discord greeting

on:
  schedule:
    - cron: '0 0 * * 1-5'    # 7 AM WIB weekdays
    - cron: '0 5 * * 1-5'    # 12 PM WIB weekdays  
    - cron: '0 10 * * 1-5'   # 5 PM WIB weekdays
    - cron: '0 15 * * 1-5'   # 10 PM WIB weekdays
    - cron: '0 0 * * 6,0'    # 7 AM WIB weekends
    - cron: '0 5 * * 6,0'    # 12 PM WIB weekends
    - cron: '0 10 * * 6,0'   # 5 PM WIB weekends
    - cron: '0 15 * * 6,0'   # 10 PM WIB weekends
  workflow_dispatch:
    inputs:
      greeting_type:
        description: 'select greeting type'
        required: true
        default: 'morning'
        type: choice
        options: [morning, afternoon, evening, night]

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Send Gemini AI Greeting
        run: |
          set -e
          
          # Determine greeting type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ github.event.inputs.greeting_type }}"
          else
            case "${{ github.event.schedule }}" in
              "0 0 * * 1-5"|"0 0 * * 6,0") TYPE="morning" ;;
              "0 5 * * 1-5"|"0 5 * * 6,0") TYPE="afternoon" ;;
              "0 10 * * 1-5"|"0 10 * * 6,0") TYPE="evening" ;;
              "0 15 * * 1-5"|"0 15 * * 6,0") TYPE="night" ;;
            esac
          fi
          
          # Check if weekend
          DAY=$(date +%u)
          if [[ $DAY -eq 6 || $DAY -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          echo "🤖 Generating greeting: $TYPE ($CONTEXT)"
          
          # English-Indo mixed slang prompt
          read -r -d '' PROMPT << 'EOF' || true
          Create a Discord greeting for TYPE_PLACEHOLDER time on CONTEXT_PLACEHOLDER day.

          Style Requirements:
          - Mix English and Indonesian naturally 
          - Heavy slang usage: "yoww", "bruh", "bestie", "periodt", "slay", "vibe check", "no cap", "fr fr", "lowkey", "highkey"
          - Indo slang: "anying", "kocak", "woy", "cuy", "gas", "santuy"
          - Gaming terms: "NPC behavior", "main character energy", "respawn", "AFK", "touching grass"
          - Gen Z vibes but not cringe

          Format output:
          TITLE: [title with emoji - mix eng/indo]
          DESC: [2-3 sentences, natural code-switching]
          > by server dev - <@399393175904714752>
          FOOTER: [short footer]

          Example tone:
          "yoww gd morning bestie! how's your dream? hope it's not NPC behavior dreams fr 😴 time to touch some grass or touch some rank, your choice periodt"

          Make it sound natural, like how Indonesian Gen Z actually talks online.
          EOF
          
          # Replace placeholders
          PROMPT=${PROMPT//TYPE_PLACEHOLDER/$TYPE}
          PROMPT=${PROMPT//CONTEXT_PLACEHOLDER/$CONTEXT}
          
          # Try Gemini API (with proper error handling)
          GEMINI_RESPONSE=""
          if curl -f -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{\"text\": \"$PROMPT\"}]
              }],
              \"generationConfig\": {
                \"temperature\": 0.8,
                \"maxOutputTokens\": 200
              }
            }" \
            --connect-timeout 10 --max-time 15 > /tmp/gemini_response.json 2>/dev/null; then
            
            # Parse response
            if AI_TEXT=$(jq -r '.candidates[0].content.parts[0].text' /tmp/gemini_response.json 2>/dev/null); then
              echo "✅ Gemini API success"
              echo "$AI_TEXT" > /tmp/ai_content.txt
              
              # Extract parts with simple parsing
              TITLE=$(echo "$AI_TEXT" | grep -i "TITLE:" | head -1 | sed 's/.*TITLE:[[:space:]]*//' | sed 's/^[[:space:]]*//')
              FOOTER=$(echo "$AI_TEXT" | grep -i "FOOTER:" | head -1 | sed 's/.*FOOTER:[[:space:]]*//' | sed 's/^[[:space:]]*//')
              
              # Get DESC (everything between TITLE and "> by server dev")
              DESC=$(echo "$AI_TEXT" | sed -n '/TITLE:/,/> by server dev/p' | grep -v "TITLE:" | grep -v "FOOTER:" | sed '/> by server dev/d' | tr '\n' ' ' | sed 's/DESC:[[:space:]]*//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # Add the required ending
              if [[ -n "$DESC" ]]; then
                DESC="$DESC\\n> by server dev - <@399393175904714752>"
              fi
              
              # Validate
              if [[ -n "$TITLE" && -n "$DESC" && -n "$FOOTER" ]]; then
                echo "✅ Parsing successful"
                echo "Title: $TITLE"
                echo "Footer: $FOOTER"
                USE_AI=true
              else
                echo "❌ Parsing failed, using fallback"
                USE_AI=false
              fi
            else
              echo "❌ JSON parsing failed"
              USE_AI=false
            fi
          else
            echo "❌ Gemini API call failed"
            USE_AI=false
          fi
          
          # Fallback messages if AI fails
          if [[ "$USE_AI" != "true" ]]; then
            echo "🎲 Using fallback greeting"
            INDEX=$((RANDOM % 3))
            
            case "$TYPE-$INDEX" in
              "morning-0")
                TITLE="🌄 yoww gd morning bestie"
                DESC="how's your dream? hope it's not NPC behavior dreams fr 😴 time to touch grass or touch rank periodt\\n> by server dev - <@399393175904714752>"
                FOOTER="main character energy"
                ;;
              "morning-1")
                TITLE="🌅 morning vibe check bestie"
                DESC="yoww what's the tea? coffee first then we slay the day no cap ☕ don't be giving dead energy anying\\n> by server dev - <@399393175904714752>"
                FOOTER="periodt bestie"
                ;;
              "morning-2")
                TITLE="☀️ rise n grind but make it chill"
                DESC="gm squad! lowkey today feels like a W waiting to happen fr 😌 just don't AFK your own life kocak\\n> by server dev - <@399393175904714752>"
                FOOTER="slay responsibly"
                ;;
              "afternoon-0")
                TITLE="🌞 lunch break or mental break?"
                DESC="yoww bestie! your stomach said what now? 🍔 can't be running on vibes only anying, eat something fr\\n> by server dev - <@399393175904714752>"
                FOOTER="feed the main character"
                ;;
              "afternoon-1")
                TITLE="🍔 midday energy check"
                DESC="bruh if you're feeling like an NPC rn that's valid 😴 grab some food and respawn your energy periodt\\n> by server dev - <@399393175904714752>"
                FOOTER="recharge era"
                ;;
              "afternoon-2")
                TITLE="😎 afternoon tea (or drama?)"
                DESC="yo what's good? hydrate or die-drate bestie 🥤 save the salty energy for ranked games kocak\\n> by server dev - <@399393175904714752>"
                FOOTER="stay hydrated queen"
                ;;
              "evening-0")
                TITLE="🌆 golden hour but make it cozy"
                DESC="yoww evening squad! sunset hits different when you're not tilted fr 😂 time to wind down bestie\\n> by server dev - <@399393175904714752>"
                FOOTER="chill vibes only"
                ;;
              "evening-1")
                TITLE="🌅 it's giving evening main character"
                DESC="what's the move tonight? snack, chill playlist, maybe some games anying 🎧 lowkey perfect timing\\n> by server dev - <@399393175904714752>"
                FOOTER="tonight's agenda"
                ;;
              "evening-2")
                TITLE="✨ evening bestie check-in"
                DESC="bruh today was a whole movie huh? 😌 but we survived and that's periodt, no cap\\n> by server dev - <@399393175904714752>"
                FOOTER="we been through it"
                ;;
              "night-0")
                TITLE="🌙 bedtime or grindtime?"
                DESC="yoww night owls! even your phone needs to charge bestie ⚡ maybe touch some pillows instead of screens kocak\\n> by server dev - <@399393175904714752>"
                FOOTER="sleep is self care"
                ;;
              "night-1")
                TITLE="💤 it's giving sleepy girl era"
                DESC="gn bestie! don't bring today's drama to tomorrow's energy fr 😪 reset and respawn tomorrow periodt\\n> by server dev - <@399393175904714752>"
                FOOTER="dream of Ws"
                ;;
              "night-2")
                TITLE="🌜 night night main character"
                DESC="bruh tomorrow's gonna be another episode anying, get some rest so you can slay properly no cap\\n> by server dev - <@399393175904714752>"
                FOOTER="see u in the morning"
                ;;
            esac
          fi
          
          # Set colors and thumbnails
          case "$TYPE" in
            "morning") COLOR=16766720; THUMB="1f305" ;;
            "afternoon") COLOR=16763904; THUMB="2600" ;;
            "evening") COLOR=16744448; THUMB="1f307" ;;
            "night") COLOR=8947848; THUMB="1f319" ;;
          esac
          
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          # Send to Discord
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --connect-timeout 10 --max-time 15 \
               -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"$DESC\",\"color\":$COLOR,\"thumbnail\":{\"url\":\"https://twemoji.maxcdn.com/v/latest/72x72/$THUMB.png\"},\"footer\":{\"text\":\"$FOOTER\",\"icon_url\":\"https://files.catbox.moe/npfh4e.jpg\"},\"timestamp\":\"$TIMESTAMP\"}]}"
          
          echo "✅ Sent $TYPE greeting (AI: ${USE_AI:-false}, Context: $CONTEXT)"
          
          # Cleanup
          rm -f /tmp/gemini_response.json /tmp/ai_content.txt