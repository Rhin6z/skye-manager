name: gemini ai discord greeting

on:
  schedule:
    - cron: '0 0 * * 1-5'    # 7 AM WIB weekdays
    - cron: '0 5 * * 1-5'    # 12 PM WIB weekdays  
    - cron: '0 10 * * 1-5'   # 5 PM WIB weekdays
    - cron: '0 15 * * 1-5'   # 10 PM WIB weekdays
    - cron: '0 0 * * 6,0'    # 7 AM WIB weekends
    - cron: '0 5 * * 6,0'    # 12 PM WIB weekends
    - cron: '0 10 * * 6,0'   # 5 PM WIB weekends
    - cron: '0 15 * * 6,0'   # 10 PM WIB weekends
  workflow_dispatch:
    inputs:
      greeting_type:
        description: 'select greeting type'
        required: true
        default: 'morning'
        type: choice
        options: [morning, afternoon, evening, night]

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Send Gemini AI Greeting
        run: |
          set -e
          
          # Determine greeting type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ github.event.inputs.greeting_type }}"
          else
            case "${{ github.event.schedule }}" in
              "0 0 * * 1-5"|"0 0 * * 6,0") TYPE="morning" ;;
              "0 5 * * 1-5"|"0 5 * * 6,0") TYPE="afternoon" ;;
              "0 10 * * 1-5"|"0 10 * * 6,0") TYPE="evening" ;;
              "0 15 * * 1-5"|"0 15 * * 6,0") TYPE="night" ;;
            esac
          fi
          
          # Check if weekend
          DAY=$(date +%u)
          if [[ $DAY -eq 6 || $DAY -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          echo "🤖 generating greeting: $TYPE ($CONTEXT)"
          
          # English-Indo mixed slang prompt (simplified like your working version)
          read -r -d '' PROMPT << 'EOF' || true
          Buatkan greeting Discord untuk waktu TYPE_PLACEHOLDER hari CONTEXT_PLACEHOLDER.

          Style: Indonesian slang casual + gaming terms (anying, kocak, fr, no cap, woy, santuy, gas)

          Format output:
          TITLE: [judul dengan emoji, lowercase]
          DESC: [2 kalimat casual, lowercase kecuali emoji]
          > by server dev - <@399393175904714752>
          FOOTER: [footer pendek, lowercase]

          Contoh:
          TITLE: 🌅 pagi santuy, gas tipis aja
          DESC: morning squad! jangan jadi npc parkir di base, gerak dikit udah win kocak 😂
          > by server dev - <@399393175904714752>
          FOOTER: santai tapi jalan

          Penting: semua output lowercase kecuali emoji!
          EOF
          
          # Replace placeholders
          PROMPT=${PROMPT//TYPE_PLACEHOLDER/$TYPE}
          PROMPT=${PROMPT//CONTEXT_PLACEHOLDER/$CONTEXT}
          
          # Try Gemini API (using the working model from your code)
          GEMINI_RESPONSE=""
          echo "🔄 trying gemini-1.5-flash api..."
          
          if curl -f -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{\"text\": \"$PROMPT\"}]
              }],
              \"generationConfig\": {
                \"temperature\": 0.8,
                \"maxOutputTokens\": 200
              }
            }" \
            --connect-timeout 10 --max-time 15 > /tmp/gemini_response.json 2>/dev/null; then
            
            # Parse response (simplified like your working code)
            if AI_TEXT=$(jq -r '.candidates[0].content.parts[0].text' /tmp/gemini_response.json 2>/dev/null); then
              echo "✅ gemini api success"
              echo "$AI_TEXT" > /tmp/ai_content.txt
              
              # Extract parts with simple parsing (like your working version)
              TITLE=$(echo "$AI_TEXT" | grep -i "TITLE:" | head -1 | sed 's/.*TITLE:[[:space:]]*//' | sed 's/^[[:space:]]*//')
              FOOTER=$(echo "$AI_TEXT" | grep -i "FOOTER:" | head -1 | sed 's/.*FOOTER:[[:space:]]*//' | sed 's/^[[:space:]]*//')
              
              # Get DESC (everything between TITLE and "> by server dev")
              DESC=$(echo "$AI_TEXT" | sed -n '/TITLE:/,/> by server dev/p' | grep -v "TITLE:" | grep -v "FOOTER:" | sed '/> by server dev/d' | tr '\n' ' ' | sed 's/DESC:[[:space:]]*//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # Add the required ending
              if [[ -n "$DESC" ]]; then
                DESC="$DESC\\n> by server dev - <@399393175904714752>"
              fi
              
              # Validate
              if [[ -n "$TITLE" && -n "$DESC" && -n "$FOOTER" ]]; then
                echo "✅ parsing successful"
                echo "title: $TITLE"
                echo "footer: $FOOTER"
                USE_AI=true
              else
                echo "❌ parsing failed, using fallback"
                USE_AI=false
              fi
            else
              echo "❌ json parsing failed"
              USE_AI=false
            fi
          else
            echo "❌ gemini api call failed"
            USE_AI=false
          fi
          
          # Fallback messages if AI fails (updated to lowercase indo slang style)
          if [[ "$USE_AI" != "true" ]]; then
            echo "🎲 using fallback greeting"
            INDEX=$((RANDOM % 3))
            
            case "$TYPE-$INDEX" in
              "morning-0")
                TITLE="🌄 pagi woy, gas tipis aja"
                DESC="yo morning fam! jangan jadi npc parkir di base, gerak dikit udah win fr 😂\\n> by server dev - <@399393175904714752>"
                FOOTER="santai tapi jalan"
                ;;
              "morning-1")
                TITLE="🌅 bangun santuy, hidup santuy"
                DESC="good morning squad! kopi dulu baru bacot produktif, anying ☕\\n> by server dev - <@399393175904714752>"
                FOOTER="pelan tapi konsisten"
                ;;
              "morning-2")
                TITLE="☀️ morning vibe check"
                DESC="gm legends! mmr turun ga sekejam kata netizen kok, santai kocak 😌\\n> by server dev - <@399393175904714752>"
                FOOTER="good vibes only"
                ;;
              "afternoon-0")
                TITLE="🌞 siang², break dulu"
                DESC="what's good squad? makan siang itu buff utama, bukan side quest anying 🍔\\n> by server dev - <@399393175904714752>"
                FOOTER="recharge mode"
                ;;
              "afternoon-1")
                TITLE="🍔 lunch time = sacred time"
                DESC="yo fam! jangan jadi singa di chat, koala di real life 😴\\n> by server dev - <@399393175904714752>"
                FOOTER="makan dulu boss"
                ;;
              "afternoon-2")
                TITLE="😎 tengah hari check"
                DESC="good afternoon gamers! hydrate or diedrate, minum dulu baru war kocak\\n> by server dev - <@399393175904714752>"
                FOOTER="stay hydrated"
                ;;
              "evening-0")
                TITLE="🌆 sore santai mode"
                DESC="good evening fam! sunset hits different, cooldown bentar biar ga tilt 😂\\n> by server dev - <@399393175904714752>"
                FOOTER="chill vibes"
                ;;
              "evening-1")
                TITLE="🌅 golden hour energy"
                DESC="evening squad! ganti playlist, cemil dikit, terus lanjut mabar anying\\n> by server dev - <@399393175904714752>"
                FOOTER="malam ini milik kita"
                ;;
              "evening-2")
                TITLE="✨ sore² santai"
                DESC="what's poppin brodie! ketawain aja dikit, hidup tuh ga seseram drama discord fr 😌\\n> by server dev - <@399393175904714752>"
                FOOTER="santai sejenak"
                ;;
              "night-0")
                TITLE="🌙 time to rest"
                DESC="night night squad! hp aja ada low battery warning anying ⚡ lu juga butuh tidur\\n> by server dev - <@399393175904714752>"
                FOOTER="bobo cantik"
                ;;
              "night-1")
                TITLE="💤 sleep mode activated"
                DESC="good night fam! jangan bawa rank ke mimpi, nanti mimpi dimarahin random kocak 😪\\n> by server dev - <@399393175904714752>"
                FOOTER="mimpi indah"
                ;;
              "night-2")
                TITLE="🌜 rest well"
                DESC="gn team! besok masih panjang, sekarang waktunya jadi guling enjoyer no cap\\n> by server dev - <@399393175904714752>"
                FOOTER="see u tomorrow"
                ;;
            esac
          fi
          
          # Set colors and thumbnails
          case "$TYPE" in
            "morning") COLOR=16766720; THUMB="1f305" ;;
            "afternoon") COLOR=16763904; THUMB="2600" ;;
            "evening") COLOR=16744448; THUMB="1f307" ;;
            "night") COLOR=8947848; THUMB="1f319" ;;
          esac
          
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          # Send to Discord (simplified like your working code)
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --connect-timeout 10 --max-time 15 \
               -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"$DESC\",\"color\":$COLOR,\"thumbnail\":{\"url\":\"https://twemoji.maxcdn.com/v/latest/72x72/$THUMB.png\"},\"footer\":{\"text\":\"$FOOTER\",\"icon_url\":\"https://files.catbox.moe/npfh4e.jpg\"},\"timestamp\":\"$TIMESTAMP\"}]}"
          
          echo "✅ sent $TYPE greeting (ai: ${USE_AI:-false}, context: $CONTEXT)"
          
          # Cleanup
          rm -f /tmp/gemini_response.json /tmp/ai_content.txt