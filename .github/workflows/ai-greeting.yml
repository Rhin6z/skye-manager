name: gemini ai discord greeting

on:
  schedule:
    - cron: '0 0 * * 1-5'    # 7 AM WIB weekdays
    - cron: '0 5 * * 1-5'    # 12 PM WIB weekdays  
    - cron: '0 10 * * 1-5'   # 5 PM WIB weekdays
    - cron: '0 15 * * 1-5'   # 10 PM WIB weekdays
    - cron: '0 0 * * 6,0'    # 7 AM WIB weekends
    - cron: '0 5 * * 6,0'    # 12 PM WIB weekends
    - cron: '0 10 * * 6,0'   # 5 PM WIB weekends
    - cron: '0 15 * * 6,0'   # 10 PM WIB weekends
  workflow_dispatch:
    inputs:
      greeting_type:
        description: 'select greeting type'
        required: true
        default: 'morning'
        type: choice
        options: [morning, afternoon, evening, night]

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Send Gemini AI Greeting
        run: |
          set -e
          
          # Determine greeting type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ github.event.inputs.greeting_type }}"
          else
            case "${{ github.event.schedule }}" in
              "0 0 * * 1-5"|"0 0 * * 6,0") TYPE="morning" ;;
              "0 5 * * 1-5"|"0 5 * * 6,0") TYPE="afternoon" ;;
              "0 10 * * 1-5"|"0 10 * * 6,0") TYPE="evening" ;;
              "0 15 * * 1-5"|"0 15 * * 6,0") TYPE="night" ;;
            esac
          fi
          
          # Check if weekend
          DAY=$(date +%u)
          if [[ $DAY -eq 6 || $DAY -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          echo "🤖 generating greeting: $TYPE ($CONTEXT)"
          
          # English-Indo mixed slang prompt with fresh slang
          read -r -d '' PROMPT << 'EOF' || true
          Create a Discord greeting for TYPE_PLACEHOLDER time on CONTEXT_PLACEHOLDER.

          Style requirements:
          - Start with English slang, then mix Indonesian naturally
          - Use fresh slang: "periodt", "slay", "no cap", "fr fr", "lowkey", "highkey", "bussin", "mid", "it's giving", "finna", "bet"
          - Indonesian slang: "anying", "kocak", "woy", "cuy", "gas", "santuy", "ngab", "anjir", "kampret", "gabut", "bucin", "kepo", "baper"
          - Gaming terms: "npc energy", "touching grass", "respawn", "afk life", "main character", "side quest"
          - Mix naturally, avoid being cringe
          - Everything lowercase except emojis

          Return ONLY in this exact format:
          TITLE: [short title with emoji and mixed eng-indo slang]
          DESC: [one natural sentence mixing english and indonesian slang]
          FOOTER: [short mixed footer]

          Example:
          TITLE: 🌙 yo good night bestie, malem gabut
          DESC: night night legends it's giving sleepy vibes fr! jangan begadang terus cuy, istirahat yang bener ngab
          FOOTER: sleep tight no cap

          Make it feel natural and conversational. Don't add extra text outside the format.
          EOF
          
          # Replace placeholders
          PROMPT=${PROMPT//TYPE_PLACEHOLDER/$TYPE}
          PROMPT=${PROMPT//CONTEXT_PLACEHOLDER/$CONTEXT}
          
          # Try Gemini API (using the working model from your code)
          GEMINI_RESPONSE=""
          echo "🔄 trying gemini-1.5-flash api..."
          
          if curl -f -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{\"text\": \"$PROMPT\"}]
              }],
              \"generationConfig\": {
                \"temperature\": 0.8,
                \"maxOutputTokens\": 200
              }
            }" \
            --connect-timeout 10 --max-time 15 > /tmp/gemini_response.json 2>/dev/null; then
            
            # Parse response with better handling
            if AI_TEXT=$(jq -r '.candidates[0].content.parts[0].text' /tmp/gemini_response.json 2>/dev/null); then
              echo "✅ gemini api success"
              echo "Raw AI response:"
              echo "$AI_TEXT"
              echo "---"
              
              # Clean up and extract with more robust parsing
              CLEAN_TEXT=$(echo "$AI_TEXT" | tr -d '\r' | sed 's/\*\*//g' | sed 's/\*//g')
              
              # Extract TITLE (more flexible matching)
              TITLE=$(echo "$CLEAN_TEXT" | grep -i "^TITLE:" | head -1 | sed 's/^[Tt][Ii][Tt][Ll][Ee]:[[:space:]]*//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # Extract FOOTER (more flexible matching) 
              FOOTER=$(echo "$CLEAN_TEXT" | grep -i "^FOOTER:" | head -1 | sed 's/^[Ff][Oo][Oo][Tt][Ee][Rr]:[[:space:]]*//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # Extract DESC - get everything between DESC: and > by server dev, or just after DESC:
              DESC_RAW=$(echo "$CLEAN_TEXT" | sed -n '/^[Dd][Ee][Ss][Cc]:/,/^> by server dev/p' | grep -v "^TITLE:" | grep -v "^FOOTER:" | sed '/^> by server dev/d' | sed 's/^[Dd][Ee][Ss][Cc]:[[:space:]]*//' | tr '\n' ' ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              
              # If that doesn't work, try simpler extraction
              if [[ -z "$DESC_RAW" ]]; then
                DESC_RAW=$(echo "$CLEAN_TEXT" | grep -i "^DESC:" | head -1 | sed 's/^[Dd][Ee][Ss][Cc]:[[:space:]]*//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              fi
              
              # Clean up DESC and add required ending
              if [[ -n "$DESC_RAW" ]]; then
                DESC="$DESC_RAW\\n> by server dev - <@399393175904714752>"
              fi
              
              echo "Extracted parts:"
              echo "TITLE: [$TITLE]"
              echo "DESC: [$DESC_RAW]"
              echo "FOOTER: [$FOOTER]"
              
              # Validate - more lenient validation
              if [[ -n "$TITLE" && -n "$DESC_RAW" ]]; then
                echo "✅ parsing successful"
                USE_AI=true
                # Set default footer if empty
                if [[ -z "$FOOTER" ]]; then
                  FOOTER="vibes only no cap"
                fi
              else
                echo "❌ parsing failed, using fallback"
                echo "Missing: $([ -z "$TITLE" ] && echo "TITLE ")$([ -z "$DESC_RAW" ] && echo "DESC ")"
                USE_AI=false
              fi
            else
              echo "❌ json parsing failed"
              USE_AI=false
            fi
          else
            echo "❌ gemini api call failed"
            USE_AI=false
          fi
          
          # Fallback messages with fresh eng-indo mix style
          if [[ "$USE_AI" != "true" ]]; then
            echo "🎲 using fallback greeting"
            INDEX=$((RANDOM % 3))
            
            case "$TYPE-$INDEX" in
              "morning-0")
                TITLE="🌄 good morning bestie, pagi yang slay"
                DESC="yooo what's the tea today? pagi ini lowkey giving main character energy fr! bangun santuy tapi tetep gas ngab 😂\\n> by server dev - <@399393175904714752>"
                FOOTER="periodt but make it indo"
                ;;
              "morning-1")
                TITLE="🌅 rise and grind, bangun kampret"
                DESC="morning hits different when you're not mid fr! kopi dulu baru bacot produktif anying, jangan jadi npc pagi-pagi ☕\\n> by server dev - <@399393175904714752>"
                FOOTER="bussin energy only"
                ;;
              "morning-2")
                TITLE="☀️ it's giving sunrise, pagi gabut"
                DESC="yo fam this morning is absolutely sending me! mmr turun kemarin? forget it bestie, today we finna slay kocak 😌\\n> by server dev - <@399393175904714752>"
                FOOTER="no cap pagi vibes"
                ;;
              "afternoon-0")
                TITLE="🌞 lunch break periodt, siang bucin"
                DESC="bestie your stomach said what now? makan siang itu main quest bukan side quest anying, feed yourself fr 🍔\\n> by server dev - <@399393175904714752>"
                FOOTER="recharge arc activated"
                ;;
              "afternoon-1")
                TITLE="🍛 midday check, siang kepo"
                DESC="yo it's giving sleepy vibes rn! jangan jadi singa di chat koala di dunia nyata cuy, makan dulu baru war 😴\\n> by server dev - <@399393175904714752>"
                FOOTER="touching food not grass"
                ;;
              "afternoon-2")
                TITLE="😎 afternoon tea bestie, siang anjir"
                DESC="what's poppin legends? hydrate or diedrate no cap! air putih dulu baru ranked match ngab, jangan sampai dehidrasi kocak\\n> by server dev - <@399393175904714752>"
                FOOTER="stay hydrated kampret"
                ;;
              "evening-0")
                TITLE="🌆 golden hour slay, sore anying"
                DESC="yo evening squad it's absolutely bussin! sunset hits different when you're not tilted fr, cooldown sejenak biar ga baper 😂\\n> by server dev - <@399393175904714752>"
                FOOTER="chill but make it aesthetic"
                ;;
              "evening-1")
                TITLE="🌅 it's giving sunset, sore gabut"
                DESC="evening besties what's the move? playlist chill, cemil dikit, terus lanjut mabar cuy, malam ini milik kita ngab\\n> by server dev - <@399393175904714752>"
                FOOTER="tonight we ride"
                ;;
              "evening-2")
                TITLE="✨ evening vibes, sore santuy"
                DESC="yooo this day was a whole movie periodt! hidup ga seseram drama discord anying, ketawa dikit santai sejenak 😌\\n> by server dev - <@399393175904714752>"
                FOOTER="we been through it"
                ;;
              "night-0")
                TITLE="🌙 bedtime bestie, malem kampret"
                DESC="night night legends it's giving sleepy! hp aja ada low battery warning cuy, lu juga butuh tidur fr anying ⚡\\n> by server dev - <@399393175904714752>"
                FOOTER="sleep is self care ngab"
                ;;
              "night-1")
                TITLE="💤 sleepy girl era, malem bucin"
                DESC="gn fam don't bring today's drama to tomorrow! jangan bawa rank ke mimpi nanti mimpi dimarahin random kocak 😪\\n> by server dev - <@399393175904714752>"
                FOOTER="dream of victory royales"
                ;;
              "night-2")
                TITLE="🌜 it's giving bedtime, malem gabut"
                DESC="yo besok another episode awaits fr! sekarang waktunya jadi guling enjoyer no cap, rest well legends cuy\\n> by server dev - <@399393175904714752>"
                FOOTER="see u in the morning anjir"
                ;;
            esac
          fi
          
          # Set colors and thumbnails
          case "$TYPE" in
            "morning") COLOR=16766720; THUMB="1f305" ;;
            "afternoon") COLOR=16763904; THUMB="2600" ;;
            "evening") COLOR=16744448; THUMB="1f307" ;;
            "night") COLOR=8947848; THUMB="1f319" ;;
          esac
          
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          # Send to Discord (simplified like your working code)
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --connect-timeout 10 --max-time 15 \
               -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"$DESC\",\"color\":$COLOR,\"thumbnail\":{\"url\":\"https://twemoji.maxcdn.com/v/latest/72x72/$THUMB.png\"},\"footer\":{\"text\":\"$FOOTER\",\"icon_url\":\"https://files.catbox.moe/npfh4e.jpg\"},\"timestamp\":\"$TIMESTAMP\"}]}"
          
          echo "✅ sent $TYPE greeting (ai: ${USE_AI:-false}, context: $CONTEXT)"
          
          # Cleanup
          rm -f /tmp/gemini_response.json /tmp/ai_content.txt