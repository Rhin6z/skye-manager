name: Skye Community AI Greeting

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'Source (openwrt/manual/test)'
        required: false
        default: 'manual'
        type: string
      greeting_type:
        description: 'Greeting type'
        required: false
        default: 'auto'
        type: choice
        options: [auto, morning, afternoon, evening, night]
      force_weather:
        description: 'Force weather check'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Test mode'
        required: false
        default: false
        type: boolean

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    
    steps:
      - name: Setup Context
        id: context
        run: |
          export TZ='Asia/Jakarta'
          
          OPENWRT_MODE=false
          if command -v opkg >/dev/null 2>&1 || [[ -f /etc/openwrt_release ]] || [[ "${{ github.event.inputs.trigger_source }}" == "openwrt" ]]; then
            OPENWRT_MODE=true
            echo "🏠 OpenWrt detected - optimized timing mode"
          fi
          
          CURRENT_DAY=$(date +%A)
          CURRENT_DATE=$(date +"%B %d, %Y")
          CURRENT_TIME=$(date +"%H:%M")
          HOUR=$(date +%H | sed 's/^0*//')
          DAY_NUM=$(date +%u)
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MANUAL_TYPE="${{ github.event.inputs.greeting_type }}"
            if [[ "$MANUAL_TYPE" == "auto" ]]; then
              if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
                TYPE="morning"
              elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
                TYPE="afternoon" 
              elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
                TYPE="evening"
              else
                TYPE="night"
              fi
            else
              TYPE="$MANUAL_TYPE"
            fi
          else
            if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
              TYPE="morning"
            elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
              TYPE="afternoon" 
            elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
              TYPE="evening"
            else
              TYPE="night"
            fi
          fi
          
          if [[ $DAY_NUM -eq 6 || $DAY_NUM -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          SPECIAL_CONTEXT=""
          case "$CURRENT_DAY" in
            "Monday") SPECIAL_CONTEXT="monday_motivation" ;;
            "Wednesday") SPECIAL_CONTEXT="hump_day" ;;
            "Friday") SPECIAL_CONTEXT="weekend_countdown" ;;
            "Sunday") SPECIAL_CONTEXT="sunday_prep" ;;
          esac
          
          echo "TYPE=$TYPE" >> $GITHUB_OUTPUT
          echo "CONTEXT=$CONTEXT" >> $GITHUB_OUTPUT
          echo "CURRENT_DAY=$CURRENT_DAY" >> $GITHUB_OUTPUT
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "SPECIAL_CONTEXT=$SPECIAL_CONTEXT" >> $GITHUB_OUTPUT
          echo "DAY_NUM=$DAY_NUM" >> $GITHUB_OUTPUT
          echo "OPENWRT_MODE=$OPENWRT_MODE" >> $GITHUB_OUTPUT
          
          echo "🎯 Context: $TYPE on $CURRENT_DAY ($SPECIAL_CONTEXT)"

      - name: Get Weather (BMKG Yogyakarta)
        id: weather
        run: |
          WEATHER_INFO=""
          echo "🌤️ Fetching BMKG weather for Yogyakarta..."
          
          BMKG_RAW=$(curl -s "https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=34.04.07.2001" --connect-timeout 8 --max-time 15 || echo "")
            
          if [[ -n "$BMKG_RAW" && "$BMKG_RAW" != *"error"* && "$BMKG_RAW" != *"Error"* ]]; then
            echo "✅ BMKG API response received"
            
            TEMP=$(echo "$BMKG_RAW" | grep -o '"t":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            DESC=$(echo "$BMKG_RAW" | grep -o '"weather_desc":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [[ -n "$TEMP" || -n "$DESC" ]]; then
              echo "🌡️ Raw: $TEMP°C | $DESC"
              
              WEATHER_CASUAL=""
              if [[ -n "$DESC" ]]; then
                DESC_LOWER=$(echo "$DESC" | tr '[:upper:]' '[:lower:]')
                
                if [[ "$DESC_LOWER" == *"hujan"* || "$DESC_LOWER" == *"rain"* ]]; then
                  WEATHER_CASUAL="hujan"
                elif [[ "$DESC_LOWER" == *"gerimis"* || "$DESC_LOWER" == *"drizzle"* ]]; then
                  WEATHER_CASUAL="gerimis"
                elif [[ "$DESC_LOWER" == *"panas"* || "$DESC_LOWER" == *"hot"* || "$DESC_LOWER" == *"terik"* ]]; then
                  WEATHER_CASUAL="panas"
                elif [[ "$DESC_LOWER" == *"dingin"* || "$DESC_LOWER" == *"cold"* ]]; then
                  WEATHER_CASUAL="dingin"
                elif [[ "$DESC_LOWER" == *"sejuk"* || "$DESC_LOWER" == *"cool"* || "$DESC_LOWER" == *"adem"* ]]; then
                  WEATHER_CASUAL="sejuk"
                elif [[ "$DESC_LOWER" == *"berawan"* || "$DESC_LOWER" == *"cloudy"* ]]; then
                  WEATHER_CASUAL="berawan"
                elif [[ "$DESC_LOWER" == *"cerah"* || "$DESC_LOWER" == *"sunny"* || "$DESC_LOWER" == *"clear"* ]]; then
                  WEATHER_CASUAL="cerah"
                else
                  WEATHER_CASUAL="enak"
                fi
              fi
              
              if [[ -n "$TEMP" && -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL} ${TEMP}°c"
              elif [[ -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL}"
              elif [[ -n "$TEMP" ]]; then
                WEATHER_INFO="${TEMP}°c"
              fi
              
              echo "✅ BMKG Weather: $WEATHER_INFO"
            else
              echo "⚠️ Could not extract weather data from BMKG response"
              WEATHER_INFO="cuaca enak"
            fi
          else
            echo "❌ BMKG API failed, using fallback"
            WEATHER_INFO="cuaca enak"
          fi
          
          # Define weather-appropriate emojis for later use
          WEATHER_EMOJI=""
          if [[ "$WEATHER_INFO" == *"hujan"* ]]; then
            WEATHER_EMOJI="🌧️"
          elif [[ "$WEATHER_INFO" == *"gerimis"* ]]; then
            WEATHER_EMOJI="🌦️"
          elif [[ "$WEATHER_INFO" == *"panas"* ]]; then
            WEATHER_EMOJI="🔥"
          elif [[ "$WEATHER_INFO" == *"dingin"* ]]; then
            WEATHER_EMOJI="❄️"
          elif [[ "$WEATHER_INFO" == *"sejuk"* ]]; then
            WEATHER_EMOJI="🍃"
          elif [[ "$WEATHER_INFO" == *"berawan"* ]]; then
            WEATHER_EMOJI="☁️"
          elif [[ "$WEATHER_INFO" == *"cerah"* ]]; then
            WEATHER_EMOJI="☀️"
          else
            WEATHER_EMOJI="🌤️"
          fi
          
          echo "WEATHER_INFO=$WEATHER_INFO" >> $GITHUB_OUTPUT
          echo "WEATHER_EMOJI=$WEATHER_EMOJI" >> $GITHUB_OUTPUT

      - name: Create AI Prompt
        id: create_prompt
        run: |
          # Create prompt file
          cat > /tmp/prompt.txt << 'EOL'
          **CONTEXT FOR THIS MESSAGE:**
          - Time: ${{ steps.context.outputs.TYPE }}
          - Day: ${{ steps.context.outputs.CURRENT_DAY }} (${{ steps.context.outputs.CONTEXT }})
          - Weather: ${{ steps.weather.outputs.WEATHER_INFO }}
          
          **ROLE:** You are a hype gaming admin for Indonesian Discord server "Skye" where members mainly play Roblox, Mobile Legends (ML), and Valorant.
          
          **MANDATORY FORMAT - EXACTLY 2 SENTENCES:**
          
          **SENTENCE 1 (100% English casual):**
          - Start with energetic opener: "yoooow", "wassuuup", "heyyyyyy", "suuuup", "oiiiii", "ayooooo"
          - Ask engaging question about their current state/mood/activity that fits the TIME and CONTEXT
          - Be creative with questions - avoid templates!
          - Examples for TIME context:
            * Morning: coffee vs controller, energy levels, weekend vs weekday vibes
            * Afternoon: lunch coma, productivity, midday energy check
            * Evening: day recap, dinner plans, wind down mode  
            * Night: insomnia, late night energy, peaceful hours
          
          **SENTENCE 2 (Indonesian invitation + gaming activity):**
          - Start with invitation: "yuuuk", "gaskeun", "gas polll", "ayooook", "siapaaaa yang mau"
          - Include specific game activities relevant to TIME:
            * Morning: warm up aim (Valorant), daily quests (ML), chill building (Roblox)
            * Afternoon: quick matches, ranked push, creative mode
            * Evening: team fights, voice chat sessions, dinner gaming
            * Night: marathon sessions, late night competitive, grinding
          - Naturally include weather: ${{ steps.weather.outputs.WEATHER_INFO }}
          - If weekend (${{ steps.context.outputs.CONTEXT }}): include "<@&1374047008829997157>" tag
          - If weekday: no role tags
          - End with appropriate emoji
          
          **CREATIVE REQUIREMENTS:**
          - ALL LOWERCASE
          - Be highly creative - vary sentence structure, questions, activities
          - Use gaming slang naturally: grinding, push rank, aim training, team fight, etc.
          - Match energy to time (chill morning vs hype night)
          - Avoid repetitive patterns - each message should feel unique
          - Include weather as natural reason for activity choice
          - 80-250 characters total
          
          **GAME-SPECIFIC ACTIVITIES TO USE:**
          - Valorant: aim training, competitive, unrated, deathmatch, headshot practice
          - Mobile Legends: ranked push, team fight, daily quests, classic matches
          - Roblox: building projects, exploration, adventures, creative mode
          
          Write a creative, unique greeting now:
          EOL

          # Create Python AI generator script
          cat > /tmp/ai_generator.py << 'EOL'
          import json
          import requests
          import os
          import sys
          import re
          
          try:
              with open('/tmp/prompt.txt', 'r') as f:
                  prompt = f.read().strip()
              
              api_key = os.environ.get('GEMINI_API_KEY')
              if not api_key:
                  print("❌ No API key")
                  sys.exit(1)
              
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key={api_key}"
              
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "generationConfig": {
                      "temperature": 0.4,
                      "maxOutputTokens": 200,
                      "topP": 0.95
                  }
              }
              
              response = requests.post(url, json=payload, timeout=20)
              
              if response.status_code == 200:
                  data = response.json()
                  if 'candidates' in data and len(data['candidates']) > 0:
                      ai_text = data['candidates'][0]['content']['parts'][0]['text'].strip()
                      
                      # Clean formatting
                      clean_text = re.sub(r'\*\*([^*]+)\*\*', r'\1', ai_text)
                      clean_text = re.sub(r'`([^`]+)`', r'\1', clean_text)
                      clean_text = re.sub(r'\n+', ' ', clean_text)
                      clean_text = ' '.join(clean_text.split())
                      
                      # Find actual greeting
                      lines = [line.strip() for line in ai_text.split('\n') if line.strip()]
                      best_line = ""
                      
                      for line in lines:
                          if (len(line) > 50 and 
                              not line.startswith(('**', '#', '-', '*', 'Context:', 'Weather:', 'Time:', 'Day:')) and
                              not line.lower().startswith(('greeting:', 'message:', 'response:', 'output:', 'here'))) :
                              if ('?' in line):
                                  best_line = line
                                  break
                      
                      if not best_line and clean_text:
                          best_line = clean_text
                      
                      if best_line and len(best_line) > 50:
                          with open('/tmp/ai_response.txt', 'w', encoding='utf-8') as f:
                              f.write(best_line)
                          print("✅ AI generation successful")
                          sys.exit(0)
              
              print("❌ AI generation failed - invalid response")
              sys.exit(1)
              
          except Exception as e:
              print(f"❌ AI generation failed: {e}")
              sys.exit(1)
          EOL

          # Create Discord payload script
          cat > /tmp/discord_script.py << 'EOL'
          import json
          import os
          
          title = os.environ.get('TITLE', 'Skye Squad')
          desc_raw = os.environ.get('DESC', 'what\'s good everyone!')
          color = int(os.environ.get('COLOR', '16766720'))
          timestamp = os.environ.get('TIMESTAMP', '')
          thumb = os.environ.get('THUMB', '1f305')
          
          # Convert description to lowercase
          desc = desc_raw.lower()
          
          # Add signature
          desc += "\n> by server dev guanteng - <@399393175904714752>"
          
          embed = {
              "title": title,
              "description": desc,
              "color": color,
              "thumbnail": {
                  "url": f"https://twemoji.maxcdn.com/v/latest/72x72/{thumb}.png"
              },
              "footer": {
                  "text": "chill gaming vibes",
                  "icon_url": "https://files.catbox.moe/npfh4e.jpg"
              },
              "timestamp": timestamp
          }
          
          payload = {"embeds": [embed]}
          
          with open('/tmp/discord_payload.json', 'w', encoding='utf-8') as f:
              json.dump(payload, f, ensure_ascii=False)
          
          print("✅ Payload created")
          EOL

      - name: Generate AI Greeting
        id: ai_generation
        run: |
          echo "🤖 Generating AI greeting..."
          
          # Execute the Python script
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} python3 /tmp/ai_generator.py
          
          if [[ $? -eq 0 && -s /tmp/ai_response.txt ]]; then
            AI_TEXT=$(cat /tmp/ai_response.txt)
            echo "🎯 AI generated: $AI_TEXT"
            
            # Improved validation with better pattern matching
            HAS_ENGLISH_PART=$(echo "$AI_TEXT" | grep -E "\?" || echo "")
            HAS_INDONESIAN_PART=$(echo "$AI_TEXT" | grep -iE "(yu+k|gas|ayo+k*|pada|hayu+k|gaskeun|mabar|santuy|ngepush|main bareng)" || echo "")
            HAS_WEATHER=$(echo "$AI_TEXT" | grep -iE "(cuaca|hujan|gerimis|cerah|panas|dingin|sejuk|berawan|mendung|rainy|sunny|hot|cold|weather|rain)" || echo "")
            HAS_QUESTION=$(echo "$AI_TEXT" | grep -E "\?" || echo "")
            
            # Check for tag existence
            HAS_TAG=$(echo "$AI_TEXT" | grep -E "<@&[0-9]+>" || echo "")
            
            # Auto-fix for missing Indonesian part
            if [[ -z "$HAS_INDONESIAN_PART" ]]; then
              echo "⚠️ Missing Indonesian part, attempting to fix..."
              
              if [[ "${{ steps.context.outputs.CONTEXT }}" == "weekend" && -z "$HAS_TAG" ]]; then
                # Create weekend fallback with tag
                case "${{ steps.context.outputs.TYPE }}" in
                  "morning")
                    SECOND_PART="yuuuk <@&1374047008829997157> ngopi sambil warm up aim dulu, ${{ steps.weather.outputs.WEATHER_INFO }} perfect buat fokus grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                  "afternoon")
                    SECOND_PART="gaskeun <@&1374047008829997157> quick match sambil santai, ${{ steps.weather.outputs.WEATHER_INFO }} pas buat chill gaming! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                  "evening")
                    SECOND_PART="gas polll <@&1374047008829997157> mabar sambil makan malam, ${{ steps.weather.outputs.WEATHER_INFO }} bikin mood relaxing! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                  "night")
                    SECOND_PART="hayuuuk <@&1374047008829997157> push rank marathon sampe pagi, ${{ steps.weather.outputs.WEATHER_INFO }} enak buat grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                esac
              elif [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" && -z "$HAS_TAG" ]]; then
                # Create weekday fallback without tag
                case "${{ steps.context.outputs.TYPE }}" in
                  "morning")
                    SECOND_PART="yuuuk ngopi sambil warm up aim dulu, ${{ steps.weather.outputs.WEATHER_INFO }} perfect buat fokus grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                  "afternoon")
                    SECOND_PART="gaskeun quick match sambil santai, ${{ steps.weather.outputs.WEATHER_INFO }} pas buat chill gaming! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                  "evening")
                    SECOND_PART="gas polll mabar sambil makan malam, ${{ steps.weather.outputs.WEATHER_INFO }} bikin mood relaxing! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                  "night")
                    SECOND_PART="hayuuuk push rank marathon sampe pagi, ${{ steps.weather.outputs.WEATHER_INFO }} enak buat grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                    ;;
                esac
              else
                # Already has a tag, don't add another one
                SECOND_PART=""
              fi
              
              # Add second part if the AI only generated the first part
              if [[ "$AI_TEXT" =~ \? && -n "$SECOND_PART" ]]; then
                AI_TEXT="$AI_TEXT $SECOND_PART"
                echo "✅ Fixed by adding second part: $AI_TEXT"
              fi
            fi
            
            # Length limit check
            if [[ ${#AI_TEXT} -gt 230 ]]; then
              echo "⚠️ Message too long (${#AI_TEXT} chars), trimming..."
              # Check for tag
              if [[ "$AI_TEXT" =~ "<@&" ]]; then
                TAG_START=$(echo "$AI_TEXT" | grep -b -o "<@&" | head -1 | cut -d':' -f1)
                TAG_END=$(echo "$AI_TEXT" | cut -c$((TAG_START+1))- | grep -b -o ">" | head -1 | cut -d':' -f1)
                TAG_END=$((TAG_START + TAG_END + 1))
                
                if [[ $TAG_START -lt 220 && $TAG_END -gt 220 ]]; then
                  # Tag would be cut, adjust cut point
                  AI_TEXT=$(echo "$AI_TEXT" | cut -c1-$TAG_END)"..."
                else
                  # Normal cut
                  AI_TEXT=$(echo "$AI_TEXT" | cut -c1-220)"..."
                fi
              else
                # No tag, simple trim
                AI_TEXT=$(echo "$AI_TEXT" | cut -c1-220)"..."
              fi
            fi
            
            # Final validation
            if [[ -n "$HAS_ENGLISH_PART" && -n "$HAS_QUESTION" && (${#AI_TEXT} -gt 60) ]]; then
              DESC_RAW="$AI_TEXT"
              USE_AI=true
              echo "✅ AI validated: ${#AI_TEXT} chars"
            else
              USE_AI=false
              echo "⚠️ AI validation failed"
            fi
          else
            USE_AI=false
            echo "❌ AI generation failed, using fallback"
          fi
          
          # Fallback system
          if [[ "$USE_AI" != "true" ]]; then
            echo "🎲 Using enhanced creative fallback system..."
            
            WEATHER_MENTION="${{ steps.weather.outputs.WEATHER_INFO }}"
            WEATHER_EMOJI="${{ steps.weather.outputs.WEATHER_EMOJI }}"
            
            # Creative fallbacks dengan variasi game spesifik
            declare -a MORNING_MSGS
            declare -a AFTERNOON_MSGS  
            declare -a EVENING_MSGS
            declare -a NIGHT_MSGS
            
            # MORNING VARIATIONS (focus: coffee + warm up + daily quests)
            if [[ "${{ steps.context.outputs.CONTEXT }}" == "weekend" ]]; then
              MORNING_MSGS=(
                "yoooow weekend warriors, coffee atau controller mana yang lebih penting pagi ini? yuuuk <@&1374047008829997157> warm up aim valorant sambil ngopi, ${WEATHER_MENTION} perfect buat fokus headshot training! ${WEATHER_EMOJI}"
                "wassuuup morning legends, bangun pagi buat roblox atau kebangun karena notification push rank? gaskeun <@&1374047008829997157> daily quest mobile legends sambil sarapan, ${WEATHER_MENTION} bikin mood grinding makin mantap! ${WEATHER_EMOJI}"
                "heyyyyyy early squad, weekend energy hitting different atau masih sleepy head mode? yuuuk <@&1374047008829997157> chill gaming session sambil coffee time, ${WEATHER_MENTION} cocok banget buat morning vibes! ${WEATHER_EMOJI}"
                "oiiiii saturday/sunday crew, productive morning atau santai dulu sebelum chaos? gaskeun <@&1374047008829997157> roblox adventure sambil stretching, ${WEATHER_MENTION} bikin fresh start weekend ini! ${WEATHER_EMOJI}"
              )
            else
              MORNING_MSGS=(
                "yoooow weekday warriors, school/work energy charging atau masih loading screen mode? yuuuk quick valorant deathmatch sambil ngopi, ${WEATHER_MENTION} bikin fokus sebelum aktivitas! ${WEATHER_EMOJI}"
                "wassuuup monday-friday squad, ready to conquer hari ini atau butuh warming up dulu? gaskeun daily login mobile legends sambil sarapan, ${WEATHER_MENTION} perfect buat mood booster! ${WEATHER_EMOJI}"
                "heyyyyyy productive morning, energy level udah max atau masih butuh coffee buff? yuuuk roblox chill sambil prepare hari ini, ${WEATHER_MENTION} cocok banget buat fresh morning start! ${WEATHER_EMOJI}"
                "oiiiii weekday heroes, siap battle hari ini atau masih dalam tahap respawn? gaskeun warm up aim training sambil coffee time, ${WEATHER_MENTION} bikin concentration level naik! ${WEATHER_EMOJI}"
              )
            fi
            
            # AFTERNOON VARIATIONS (focus: lunch break + quick matches + chill)  
            if [[ "${{ steps.context.outputs.CONTEXT }}" == "weekend" ]]; then
              AFTERNOON_MSGS=(
                "yoooow afternoon squad, lunch coma hitting hard atau energy masih full throttle? yuuuk <@&1374047008829997157> quick match mobile legends sambil digest, ${WEATHER_MENTION} pas banget buat ranked push session! ${WEATHER_EMOJI}"
                "wassuuup midday legends, productive pagi tadi atau malah marathon gaming sampai sekarang? gaskeun <@&1374047008829997157> valorant competitive sambil makan siang, ${WEATHER_MENTION} bikin focus aim makin sharp! ${WEATHER_EMOJI}"
                "heyyyyyy weekend afternoon, chilling mode atau masih dalam misi completing daily quest? yuuuk <@&1374047008829997157> roblox building sambil ngadem, ${WEATHER_MENTION} perfect buat creative session! ${WEATHER_EMOJI}"
                "oiiiii saturday/sunday vibes, afternoon energy different ya atau masih sama aja? gaskeun <@&1374047008829997157> mobile legends team fight sambil snacking, ${WEATHER_MENTION} cocok buat afternoon grinding! ${WEATHER_EMOJI}"
              )
            else
              AFTERNOON_MSGS=(
                "yoooow weekday afternoon, lunch break freedom atau masih stuck dalam aktivitas? yuuuk quick valorant unrated sambil makan siang, ${WEATHER_MENTION} bikin break time makin refreshing! ${WEATHER_EMOJI}"
                "wassuuup midday heroes, energy drop post lunch atau malah naik karena makanan enak? gaskeun mobile legends classic sambil charging, ${WEATHER_MENTION} perfect buat afternoon relax! ${WEATHER_EMOJI}"  
                "heyyyyyy busy afternoon, butuh gaming break atau masih survive tanpa controller? yuuuk roblox chill sambil istirahat sejenak, ${WEATHER_MENTION} cocok banget buat mood reset! ${WEATHER_EMOJI}"
                "oiiiii productive squad, afternoon hustle masih going strong atau udah butuh gaming therapy? gaskeun valorant aim training sambil snack time, ${WEATHER_MENTION} bikin focus balik lagi! ${WEATHER_EMOJI}"
              )
            fi
            
            # EVENING VARIATIONS (focus: dinner + wind down + voice chat)
            if [[ "${{ steps.context.outputs.CONTEXT }}" == "weekend" ]]; then
              EVENING_MSGS=(
                "yoooow evening squad, day was epic adventure atau disaster yang memorable banget? yuuuk <@&1374047008829997157> dinner sambil voice chat valorant, ${WEATHER_MENTION} bikin evening vibes makin cozy! ${WEATHER_EMOJI}"
                "wassuuup golden hour legends, weekend achievement unlocked atau masih ada quest belum selesai? gaskeun <@&1374047008829997157> mobile legends party sambil makan malam, ${WEATHER_MENTION} perfect buat team bonding! ${WEATHER_EMOJI}"
                "heyyyyyy weekend evening, productive hari ini atau malah productive dalam grinding game? yuuuk <@&1374047008829997157> roblox hangout sambil dinner time, ${WEATHER_MENTION} cocok banget buat chill session! ${WEATHER_EMOJI}"
                "oiiiii saturday/sunday night, weekend vibes hitting different atau udah mulai thinking about monday? gaskeun <@&1374047008829997157> gaming marathon sambil makan bareng, ${WEATHER_MENTION} bikin evening jadi lebih seru! ${WEATHER_EMOJI}"
              )
            else
              EVENING_MSGS=(
                "yoooow evening warriors, survived another weekday atau masih dalam tahap recovery? yuuuk wind down valorant sambil dinner, ${WEATHER_MENTION} perfect buat relaxing after busy day! ${WEATHER_EMOJI}"
                "wassuuup golden hour squad, day was productive atau challenging banget sampai butuh gaming therapy? gaskeun mobile legends chill sambil makan malam, ${WEATHER_MENTION} cocok buat evening decompression! ${WEATHER_EMOJI}"
                "heyyyyyy evening legends, energy masih ada atau udah fully depleted butuh recharge? yuuuk roblox explore sambil dinner time, ${WEATHER_MENTION} bikin evening mood jadi lebih santai! ${WEATHER_EMOJI}"
                "oiiiii weekday evening, accomplished feeling atau exhausted tapi satisfied? gaskeun gaming session sambil voice chat, ${WEATHER_MENTION} perfect buat evening bonding time! ${WEATHER_EMOJI}"
              )
            fi
            
            # NIGHT VARIATIONS (focus: late night gaming + marathon + insomnia)
            if [[ "${{ steps.context.outputs.CONTEXT }}" == "weekend" ]]; then
              NIGHT_MSGS=(
                "yoooow night owls, weekend insomnia hitting atau memang pilihan begadang for maximum fun? yuuuk <@&1374047008829997157> marathon valorant sambil voice chat, ${WEATHER_MENTION} perfect buat late night competitive session! ${WEATHER_EMOJI}"
                "wassuuup midnight legends, still going strong atau udah dalam tahap zombie mode gaming? gaskeun <@&1374047008829997157> mobile legends push rank sambil ngobrol, ${WEATHER_MENTION} cocok banget buat night grinding! ${WEATHER_EMOJI}"
                "heyyyyyy nocturnal squad, peaceful late night vibes atau chaos gaming energy masih tinggi? yuuuk <@&1374047008829997157> roblox building project sambil midnight snack, ${WEATHER_MENTION} bikin creative mode activated! ${WEATHER_EMOJI}"
                "oiiiii weekend night warriors, maximum weekend utilization atau udah capek tapi belum mau stop? gaskeun <@&1374047008829997157> gaming party sampai sunrise, ${WEATHER_MENTION} perfect buat legendary night session! ${WEATHER_EMOJI}"
              )
            else
              NIGHT_MSGS=(
                "yoooow night owls, insomnia striking again atau memang sengaja begadang buat gaming time? yuuuk valorant late night session sambil voice chat, ${WEATHER_MENTION} perfect buat peaceful gaming hours! ${WEATHER_EMOJI}"
                "wassuuup midnight squad, productive day tadi jadi sekarang reward time atau escape from reality mode? gaskeun mobile legends night push sambil ngobrol, ${WEATHER_MENTION} cocok banget buat late night grinding! ${WEATHER_EMOJI}"
                "heyyyyyy nocturnal gamers, quiet night energy hitting different atau masih same chaos energy? yuuuk roblox chill exploration sambil midnight vibes, ${WEATHER_MENTION} bikin night mode jadi lebih relaxing! ${WEATHER_EMOJI}"
                "oiiiii late night legends, tomorrow's problem for tomorrow atau masih mikirin hari ini sambil gaming? gaskeun night gaming therapy session, ${WEATHER_MENTION} perfect buat clearing mind! ${WEATHER_EMOJI}"
              )
            fi
            
            # Select random message berdasarkan waktu
            case "${{ steps.context.outputs.TYPE }}" in
              "morning")
                RANDOM_INDEX=$((RANDOM % ${#MORNING_MSGS[@]}))
                DESC_RAW="${MORNING_MSGS[$RANDOM_INDEX]}"
                ;;
              "afternoon") 
                RANDOM_INDEX=$((RANDOM % ${#AFTERNOON_MSGS[@]}))
                DESC_RAW="${AFTERNOON_MSGS[$RANDOM_INDEX]}"
                ;;
              "evening")
                RANDOM_INDEX=$((RANDOM % ${#EVENING_MSGS[@]}))
                DESC_RAW="${EVENING_MSGS[$RANDOM_INDEX]}"
                ;;
              "night")
                RANDOM_INDEX=$((RANDOM % ${#NIGHT_MSGS[@]}))
                DESC_RAW="${NIGHT_MSGS[$RANDOM_INDEX]}"
                ;;
            esac
            
            echo "🎯 Selected creative fallback: ${DESC_RAW:0:100}..."
          fi
          
          # Set title and thumbnail based on time and weather
          if [[ "${{ steps.context.outputs.TYPE }}" == "morning" ]]; then
            if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
              TITLE="☔ Rainy Morning Vibes"
              THUMB="2614"
            else
              TITLE="☀️ Morning Skye Squad"
              THUMB="2600"
            fi
          elif [[ "${{ steps.context.outputs.TYPE }}" == "afternoon" ]]; then
            if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
              TITLE="🌧️ Rainy Afternoon Chill"
              THUMB="1f327"
            else
              TITLE="🍃 Afternoon Chill Mode"
              THUMB="1f343"
            fi
          elif [[ "${{ steps.context.outputs.TYPE }}" == "evening" ]]; then
            if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
              TITLE="🌧️ Rainy Evening Chill"
              THUMB="1f327"
            else
              TITLE="🌇 Evening Chill Squad"
              THUMB="1f307"
            fi
          else
            if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
              TITLE="🌧️ Rainy Night Gaming"
              THUMB="1f327"
            else
              TITLE="🦉 Late Night Squad"
              THUMB="1f989"
            fi
          fi
          
          # Output values for next steps
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "DESC_RAW=$DESC_RAW" >> $GITHUB_OUTPUT
          echo "USE_AI=$USE_AI" >> $GITHUB_OUTPUT
          echo "THUMB=$THUMB" >> $GITHUB_OUTPUT

      - name: Send Discord Message
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "📤 Sending Discord message..."
          
          case "${{ steps.context.outputs.TYPE }}" in
            "morning") COLOR=16766720 ;;
            "afternoon") COLOR=16763904 ;;
            "evening") COLOR=16744448 ;;
            "night") COLOR=8947848 ;;
          esac
          
          TITLE="${{ steps.ai_generation.outputs.TITLE }}"
          DESC="${{ steps.ai_generation.outputs.DESC_RAW }}"
          THUMB="${{ steps.ai_generation.outputs.THUMB }}"
          TIMESTAMP=$(TZ='Asia/Jakarta' date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          # Run Python script with environment variables
          TITLE="$TITLE" DESC="$DESC" COLOR="$COLOR" TIMESTAMP="$TIMESTAMP" THUMB="$THUMB" python3 /tmp/discord_script.py
          
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --data-binary @/tmp/discord_payload.json
          
          echo "✅ Message sent!"
          echo "🤖 AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"

      - name: Test Mode Output
        if: ${{ github.event.inputs.test_mode == 'true' }}
        run: |
          echo "🧪 TEST MODE - Message preview:"
          echo "================================"
          echo "Title: ${{ steps.ai_generation.outputs.TITLE }}"
          echo "Description: ${{ steps.ai_generation.outputs.DESC_RAW }}"
          echo "AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "Context: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.SPECIAL_CONTEXT }})"
          echo "OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          echo "================================"
          echo "🧪 Test complete - no message sent"

      - name: Send Random Sticker
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "🎲 Sending random sticker..."
          
          if [[ "${{ steps.context.outputs.OPENWRT_MODE }}" == "true" ]]; then
            echo "🏠 OpenWrt mode - sending sticker immediately"
            sleep 1
          else
            echo "⏰ Standard delay for sticker..."
            sleep 3
          fi
          
          # Simple sticker selection
          if [[ "${{ steps.context.outputs.TYPE }}" == "morning" ]]; then
            STICKER="https://media.discordapp.net/stickers/1404543938815197306.png"
          elif [[ "${{ steps.context.outputs.TYPE }}" == "afternoon" ]]; then
            STICKER="https://media.discordapp.net/stickers/1405487683526201404.png"
          elif [[ "${{ steps.context.outputs.TYPE }}" == "evening" ]]; then
            STICKER="https://media.discordapp.net/stickers/1405914196922597549.png"
          else
            STICKER="https://media.discordapp.net/stickers/1406668584335184003.png"
          fi
          
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               -d "{\"content\":\"$STICKER\"}"
          
          echo "🎉 Sticker sent!"

      - name: Execution Summary
        run: |
          echo "📊 EXECUTION SUMMARY"
          echo "================================"
          echo "🕐 Time: ${{ steps.context.outputs.CURRENT_TIME }} WIB (${{ steps.context.outputs.CURRENT_DAY }})"
          echo "🎯 Type: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.CONTEXT }})"
          echo "🌤️ Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "🤖 AI Success: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "🏠 OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          echo "🧪 Test Mode: ${{ github.event.inputs.test_mode }}"
          echo "================================"
          echo "✅ Skye community greeting complete!"