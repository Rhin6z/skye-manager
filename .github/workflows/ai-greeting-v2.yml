name: Skye Community AI Greeting

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'Source (openwrt/manual/test)'
        required: false
        default: 'manual'
        type: string
      greeting_type:
        description: 'Greeting type'
        required: false
        default: 'auto'
        type: choice
        options: [auto, morning, afternoon, evening, night]
      force_weather:
        description: 'Force weather check'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Test mode'
        required: false
        default: false
        type: boolean
      use_test_webhook:
        description: 'Send to test webhook'
        required: false
        default: false
        type: boolean

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    
    steps:
      - name: Setup Context
        id: context
        run: |
          export TZ='Asia/Jakarta'
          
          OPENWRT_MODE=false
          if command -v opkg >/dev/null 2>&1 || [[ -f /etc/openwrt_release ]] || [[ "${{ github.event.inputs.trigger_source }}" == "openwrt" ]]; then
            OPENWRT_MODE=true
            echo "üè† OpenWrt detected - optimized timing mode"
          fi
          
          CURRENT_DAY=$(date +%A)
          CURRENT_DATE=$(date +"%B %d, %Y")
          CURRENT_TIME=$(date +"%H:%M")
          HOUR=$(date +%H | sed 's/^0*//')
          DAY_NUM=$(date +%u)
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MANUAL_TYPE="${{ github.event.inputs.greeting_type }}"
            if [[ "$MANUAL_TYPE" == "auto" ]]; then
              if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
                TYPE="morning"
              elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
                TYPE="afternoon" 
              elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
                TYPE="evening"
              else
                TYPE="night"
              fi
            else
              TYPE="$MANUAL_TYPE"
            fi
          else
            if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
              TYPE="morning"
            elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
              TYPE="afternoon" 
            elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
              TYPE="evening"
            else
              TYPE="night"
            fi
          fi
          
          if [[ $DAY_NUM -eq 6 || $DAY_NUM -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          SPECIAL_CONTEXT=""
          case "$CURRENT_DAY" in
            "Monday") SPECIAL_CONTEXT="monday_motivation" ;;
            "Wednesday") SPECIAL_CONTEXT="hump_day" ;;
            "Friday") SPECIAL_CONTEXT="weekend_countdown" ;;
            "Sunday") SPECIAL_CONTEXT="sunday_prep" ;;
          esac
          
          echo "TYPE=$TYPE" >> $GITHUB_OUTPUT
          echo "CONTEXT=$CONTEXT" >> $GITHUB_OUTPUT
          echo "CURRENT_DAY=$CURRENT_DAY" >> $GITHUB_OUTPUT
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "SPECIAL_CONTEXT=$SPECIAL_CONTEXT" >> $GITHUB_OUTPUT
          echo "DAY_NUM=$DAY_NUM" >> $GITHUB_OUTPUT
          echo "OPENWRT_MODE=$OPENWRT_MODE" >> $GITHUB_OUTPUT
          
          echo "üéØ Context: $TYPE on $CURRENT_DAY ($SPECIAL_CONTEXT)"

      - name: Get Weather (BMKG Yogyakarta)
        id: weather
        run: |
          WEATHER_INFO=""
          echo "üå§Ô∏è Fetching BMKG weather for Yogyakarta..."
          
          BMKG_RAW=$(curl -s "https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=34.04.07.2001" --connect-timeout 8 --max-time 15 || echo "")
            
          if [[ -n "$BMKG_RAW" && "$BMKG_RAW" != *"error"* && "$BMKG_RAW" != *"Error"* ]]; then
            echo "‚úÖ BMKG API response received"
            
            TEMP=$(echo "$BMKG_RAW" | grep -o '"t":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            DESC=$(echo "$BMKG_RAW" | grep -o '"weather_desc":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [[ -n "$TEMP" || -n "$DESC" ]]; then
              echo "üå°Ô∏è Raw: $TEMP¬∞C | $DESC"
              
              WEATHER_CASUAL=""
              if [[ -n "$DESC" ]]; then
                DESC_LOWER=$(echo "$DESC" | tr '[:upper:]' '[:lower:]')
                
                if [[ "$DESC_LOWER" == *"hujan"* || "$DESC_LOWER" == *"rain"* ]]; then
                  WEATHER_CASUAL="hujan"
                elif [[ "$DESC_LOWER" == *"gerimis"* || "$DESC_LOWER" == *"drizzle"* ]]; then
                  WEATHER_CASUAL="gerimis"
                elif [[ "$DESC_LOWER" == *"panas"* || "$DESC_LOWER" == *"hot"* || "$DESC_LOWER" == *"terik"* ]]; then
                  WEATHER_CASUAL="panas"
                elif [[ "$DESC_LOWER" == *"dingin"* || "$DESC_LOWER" == *"cold"* ]]; then
                  WEATHER_CASUAL="dingin"
                elif [[ "$DESC_LOWER" == *"sejuk"* || "$DESC_LOWER" == *"cool"* || "$DESC_LOWER" == *"adem"* ]]; then
                  WEATHER_CASUAL="sejuk"
                elif [[ "$DESC_LOWER" == *"berawan"* || "$DESC_LOWER" == *"cloudy"* ]]; then
                  WEATHER_CASUAL="berawan"
                elif [[ "$DESC_LOWER" == *"cerah"* || "$DESC_LOWER" == *"sunny"* || "$DESC_LOWER" == *"clear"* ]]; then
                  WEATHER_CASUAL="cerah"
                else
                  WEATHER_CASUAL="enak"
                fi
              fi
              
              if [[ -n "$TEMP" && -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL} ${TEMP}¬∞c"
              elif [[ -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL}"
              elif [[ -n "$TEMP" ]]; then
                WEATHER_INFO="${TEMP}¬∞c"
              fi
              
              echo "‚úÖ BMKG Weather: $WEATHER_INFO"
            else
              echo "‚ö†Ô∏è Could not extract weather data from BMKG response"
              WEATHER_INFO="cuaca enak"
            fi
          else
            echo "‚ùå BMKG API failed, using fallback"
            WEATHER_INFO="cuaca enak"
          fi
          
          WEATHER_EMOJI="üå§Ô∏è"
          echo "WEATHER_INFO=$WEATHER_INFO" >> $GITHUB_OUTPUT
          echo "WEATHER_EMOJI=$WEATHER_EMOJI" >> $GITHUB_OUTPUT

      - name: Generate AI Greeting
        id: ai_generation
        env:
          CURRENT_DAY: ${{ steps.context.outputs.CURRENT_DAY }}
          TIME_OF_DAY: ${{ steps.context.outputs.TYPE }}
          CONTEXT: ${{ steps.context.outputs.CONTEXT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ü§ñ generating ai greeting (natural, no weather)‚Ä¶"

          # weekend flag
          if [ "$CONTEXT" = "weekend" ]; then
            export IS_WEEKEND=true
          else
            export IS_WEEKEND=false
          fi
          
          # ---------- python generator (no weather mention) ----------
          cat > /tmp/fixed_contextual_generator.py << 'EOL'
          import os, re, random, requests, sys

          """
          SLANG_GLOSSARY (arti asli singkat):
          indo:
            - yuk/yuuuk/yok/ayoo: ajakan halus mulai
            - gas: ayo jalan sekarang
            - gaskeun: push terus tanpa ragu
          english:
            - crew/squad/team: panggilan komunal santai
            - vibe: suasana; grind: kerja keras; queue up: antri match
            - dialed in: fokus siap; booting: masih pemanasan
          """

          def coin(p=0.5): 
              import random
              return random.random() < p

          # english opener (natural, no dash, no "check-in/roll call")
          def first_en(day, time, is_weekend):
              openers = ["yoooow", "heyyy", "yo", "sup", "hey team", "morning fam", "what's good"]
              labels = {
                "morning":[ f"{day} morning crew", f"{day} morning", f"{day} a.m." ],
                "afternoon":[ f"{day} afternoon squad", f"{day} afternoon", f"{day} midday" ],
                "evening":[ f"{day} evening crew", f"{day} evening", f"{day} dusk" ],
                "night":[ f"{day} night squad", f"{day} night", f"{day} late" ],
              }
              hooks = [
                "coffee ready",
                "keep it steady",
                "we move",
                "heads on",
                "feeling sharp",
                "light and easy",
              ]
              lead = (random.choice(openers) + " " if coin(0.6) else "") + random.choice(labels.get(time, [f"{day} {time}"]))
              hook = random.choice(hooks)
              sent = f"{lead}, {hook}?"
              return sent

          # indonesian follow-up (context only, no weather)
          def second_id(day, time, is_weekend):
              games = ["valorant","mobile legends","roblox"]
              if time=="morning" and not is_weekend:
                  later = random.choice(["nanti sore","abis pulang","malem nanti","abis tugas kelar"])
                  lines = [
                    f"prioritas tugas dulu, {random.choice(games)} {later}",
                    f"fokus sekolah atau kerja dulu, {random.choice(games)} {later}",
                    f"rapihin to-do dulu, {random.choice(games)} {later}",
                    f"serius dulu bentar, baru santai {random.choice(games)} {later}",
                  ]
                  starter = random.choice(["yuk","yuuuk","yok","gas","gaskeun","ayoo"])
                  return f"{starter} {random.choice(lines)}"
              # other times
              recs_day = {
                "afternoon": [
                  f"quick match {random.choice(games)} pas break",
                  f"{random.choice(games)} classic bentar",
                  f"aim training tipis-tipis",
                  f"voice chat {random.choice(games)} sambil ngemil",
                ],
                "evening": [
                  f"mabar {random.choice(games)} santai",
                  f"{random.choice(games)} sambil dinner",
                  f"comms on, {random.choice(games)} yuk",
                  f"push tipis di {random.choice(games)}",
                ],
                "night": [
                  f"unrated {random.choice(games)} bentar terus rest",
                  f"{random.choice(games)} chill session",
                  f"wind down sambil {random.choice(games)}",
                  f"last queue tipis di {random.choice(games)}",
                ],
              }
              bucket = recs_day.get(time, [
                  f"{random.choice(games)} session bareng",
                  f"quick match {random.choice(games)}",
              ])
              starter = random.choice(["yuk","yuuuk","yok","gas","gaskeun","ayoo"])
              tag = " <@&1374047008829997157>" if is_weekend else ""
              return f"{starter}{tag} {random.choice(bucket)}"

          def sanitize(s: str) -> str:
              s = s.replace("‚Äî", ",").replace("‚Äì", ",")
              s = re.sub(r"\s+,", ",", s)
              s = re.sub(r"\s+", " ", s).strip().lower()
              return s

          def build():
              day = os.environ.get("CURRENT_DAY","today").lower()
              time = os.environ.get("TIME_OF_DAY","day")
              is_weekend = os.environ.get("IS_WEEKEND","false").lower()=="true"
              first = first_en(day, time, is_weekend)
              if "?" not in first: first = first.rstrip(".") + "?"
              second = second_id(day, time, is_weekend)
              msg = sanitize(first + " " + second)
              # ensure english-only on first sentence
              first_part = msg.split("?",1)[0]
              if re.search(r"\b(yuk|yuuuk|yok|gas|gaskeun|atau|dulu|gini|aja|sama|juga|kali|deh|dong|lah|nih|yg|kuy|mabar|anjay|wkwk|njir|udah|ntar|besok|gue|gua|kamu|lu)\b", first_part):
                  msg = re.sub(r"^.*?\?", f"{day} {time} crew, keep it steady? ", msg)
              return msg

          try:
              day = os.environ.get("CURRENT_DAY","today").lower()
              time = os.environ.get("TIME_OF_DAY","day")
              is_weekend = os.environ.get("IS_WEEKEND","false").lower()=="true"
              api_key = os.environ.get("GEMINI_API_KEY")
              if api_key:
                  if time=="morning" and not is_weekend:
                      prompt = f"""write a discord greeting for {day} morning (weekday), 2 sentences, all lowercase.
              sentence 1: english only, short and natural. end with '?'.
              sentence 2: indonesian, productivity first then gaming later (valorant/mobile legends/roblox). write only the greeting."""
                  elif time=="morning" and is_weekend:
                      prompt = f"""write a discord greeting for {day} morning (weekend), 2 sentences, all lowercase.
              sentence 1: english only, short and natural. end with '?'.
              sentence 2: indonesian, start with yuk/yuuuk/yok/gas/gaskeun + <@&1374047008829997157>, include one game. write only the greeting."""
                  else:
                      prompt = f"""write a discord greeting for {day} {time}, 2 sentences, all lowercase.
              sentence 1: english only, short and natural. end with '?'.
              sentence 2: indonesian, invite to valorant/mobile legends/roblox. write only the greeting."""
                  url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={api_key}"
                  payload = {"contents":[{"parts":[{"text":prompt}]}],"generationConfig":{"temperature":0.66,"maxOutputTokens":110,"topP":0.9}}
                  r = requests.post(url, json=payload, timeout=15)
                  if r.status_code==200:
                      data = r.json()
                      cand = (data.get("candidates") or [None])[0]
                      if cand and cand.get("finishReason")!="MAX_TOKENS":
                          parts = cand.get("content",{}).get("parts") or []
                          if parts and "text" in parts[0]:
                              t = parts[0]["text"].strip().lower()
                              t = re.sub(r"\*+|\n+"," ",t); t = " ".join(t.split())
                              if "?" not in t: t = re.sub(r"\.", "?", t, count=1)
                              msg = sanitize(t)
                              # weekday morning: no game names in first sentence
                              if time=="morning" and not is_weekend:
                                  first_part = msg.split("?",1)[0]
                                  if re.search(r"\b(apex|valorant|mobile legends|roblox|gaming|main|mabar|push rank|competitive)\b", first_part):
                                      raise ValueError("gaming in first sentence")
                              if 50 <= len(msg) <= 200:
                                  open("/tmp/ai_response.txt","w",encoding="utf-8").write(msg)
                                  print("‚úÖ gemini ok"); sys.exit(0)
              # fallback local
              msg = build()
              open("/tmp/ai_response.txt","w",encoding="utf-8").write(msg)
              print("‚úÖ local generator ok"); sys.exit(0)
          except Exception as e:
              print("‚ö†Ô∏è", e)
              msg = build()
              open("/tmp/ai_response.txt","w",encoding="utf-8").write(msg)
              print("‚úÖ exception fallback ok"); sys.exit(0)
          EOL

          # ---------- payload script ----------
          cat > /tmp/discord_script.py << 'EOL'
          import json, os
          title = os.environ.get('TITLE', 'Skye Squad')
          desc_raw = os.environ.get('DESC', "what's good everyone!")
          color = int(os.environ.get('COLOR', '16766720'))
          timestamp = os.environ.get('TIMESTAMP', '')
          thumb = os.environ.get('THUMB', '1f305')
          desc = (desc_raw or '').lower()
          desc += "\n> by server dev guanteng - <@399393175904714752>"
          embed = {
              "title": title,
              "description": desc,
              "color": color,
              "thumbnail": {"url": f"https://twemoji.maxcdn.com/v/latest/72x72/{thumb}.png"},
              "footer": {"text": "chill gaming vibes", "icon_url": "https://files.catbox.moe/npfh4e.jpg"},
              "timestamp": timestamp
          }
          with open('/tmp/discord_payload.json', 'w', encoding='utf-8') as f:
              json.dump({"embeds": [embed]}, f, ensure_ascii=False)
          print("‚úÖ payload created")
          EOL

          # ---------- run ----------
          echo "üß™ executing generator..."
          python3 /tmp/fixed_contextual_generator.py
          
          # ---------- process result ----------
          if [[ -s /tmp/ai_response.txt ]]; then
            AI_TEXT=$(cat /tmp/ai_response.txt)
            echo "üéØ generated: $AI_TEXT"
            if [[ ${#AI_TEXT} -gt 40 && ${#AI_TEXT} -lt 250 ]]; then
              if [[ "$CONTEXT" == "weekend" ]]; then
                HAS_TAG=$(echo "$AI_TEXT" | grep -E "<@&[0-9]+>" || echo "")
                if [[ -z "$HAS_TAG" ]]; then
                  if [[ "$AI_TEXT" == *"?"* ]]; then
                    AI_TEXT=$(echo "$AI_TEXT" | sed 's/? /? <@&1374047008829997157> /')
                  else
                    AI_TEXT="$AI_TEXT <@&1374047008829997157>"
                  fi
                fi
              else
                AI_TEXT=$(echo "$AI_TEXT" | sed 's/<@&[0-9]*>//g')
              fi
              # style fixes
              AI_TEXT=$(echo "$AI_TEXT" | tr '‚Äì‚Äî' ',')
              AI_TEXT=$(echo "$AI_TEXT" | sed 's/school\/work/school or work/gI' | sed 's/sekolah\/kerja/sekolah atau kerja/gI')
              AI_TEXT=$(echo "$AI_TEXT" | sed -E 's/[üéÆüíØüî•‚ö°‚ú®üéØüí™üöÄ‚òïüìö]+$//')
              AI_TEXT=$(echo "$AI_TEXT" | tr -s ' ')
              [ ${#AI_TEXT} -gt 200 ] && AI_TEXT="${AI_TEXT:0:190}..."
              DESC_RAW="$AI_TEXT"; USE_AI=true
              echo "‚úÖ text accepted (${#AI_TEXT} chars)"
            else
              echo "‚ùå invalid length (${#AI_TEXT})"; USE_AI=false
            fi
          else
            echo "‚ùå no ai response"; USE_AI=false
          fi
          
          # ---------- bash fallback (no weather mention) ----------
          if [[ "$USE_AI" != "true" ]]; then
            DAY=$(echo "$CURRENT_DAY" | tr '[:upper:]' '[:lower:]')
            case "$TIME_OF_DAY" in
              morning) FIRST="$(shuf -e "yoooow $DAY morning crew, coffee ready?" "hey team $DAY morning, keep it steady?" "$DAY morning, we move?" -n1)" ;;
              afternoon) FIRST="$(shuf -e "$DAY afternoon squad, heads on?" "$DAY afternoon, keep it light?" -n1)" ;;
              evening) FIRST="$(shuf -e "$DAY evening crew, dinner first?" "$DAY evening, feeling sharp?" -n1)" ;;
              night) FIRST="$(shuf -e "$DAY night squad, wind down?" "$DAY night, we moving?" -n1)" ;;
            esac
            if [[ "$TIME_OF_DAY" = "morning" && "$CONTEXT" != "weekend" ]]; then
              GAME=$(shuf -e valorant "mobile legends" roblox -n1)
              LATER=$(shuf -e "nanti sore" "abis pulang" "malem nanti" "abis tugas kelar" -n1)
              SECOND=$(shuf -e "yuk prioritas tugas dulu, $GAME $LATER" "yok fokus sekolah atau kerja dulu, $GAME $LATER" "gas rapihin to-do dulu, $GAME $LATER" -n1)
            else
              GAME=$(shuf -e valorant "mobile legends" roblox -n1)
              TAG=""; [[ "$CONTEXT" = "weekend" ]] && TAG=" <@&1374047008829997157>"
              SECOND=$(shuf -e "yuk mabar $GAME santai$TAG" "gas quick match $GAME$TAG" "yok comms on, $GAME yuk$TAG" -n1)
            fi
            DESC_RAW="$FIRST $SECOND"
          fi
          
          # dynamic titles (randomized per time of day) + thumbs per time
          case "$TIME_OF_DAY" in
            "morning")
              TITLE=$(shuf -e "good morning skyers" "rise and shine skye squad" "morning, team skye" "fresh start crew" "a.m. vibes, skye" "new day new queue" -n1)
              THUMB="2600"
              ;;
            "afternoon")
              TITLE=$(shuf -e "good afternoon skyers" "midday momentum" "afternoon grind" "after lunch squad" "keep it rolling" "pm vibes, skye" -n1)
              THUMB="1f343"
              ;;
            "evening")
              TITLE=$(shuf -e "evening chill skyers" "golden hour crew" "evening run" "after hours squad" "soft light, skye" "evening mode on" -n1)
              THUMB="1f307"
              ;;
            "night")
              TITLE=$(shuf -e "good night skyers" "night mode on" "late shift squad" "midnight crew" "slow down team" "lights low, skye" -n1)
              THUMB="1f989"
              ;;
          esac
          
          # outputs
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "DESC_RAW=$DESC_RAW" >> $GITHUB_OUTPUT
          echo "USE_AI=$USE_AI" >> $GITHUB_OUTPUT
          echo "THUMB=$THUMB" >> $GITHUB_OUTPUT

      - name: Send Discord Message
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "üì§ Sending Discord message..."
          
          case "${{ steps.context.outputs.TYPE }}" in
            "morning") COLOR=16766720 ;;
            "afternoon") COLOR=16763904 ;;
            "evening") COLOR=16744448 ;;
            "night") COLOR=8947848 ;;
          esac
          
          TITLE="${{ steps.ai_generation.outputs.TITLE }}"
          DESC="${{ steps.ai_generation.outputs.DESC_RAW }}"
          THUMB="${{ steps.ai_generation.outputs.THUMB }}"
          TIMESTAMP=$(TZ='Asia/Jakarta' date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          if [[ "${{ github.event.inputs.use_test_webhook }}" == "true" ]]; then
            WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_TEST }}"
            echo "Using TEST webhook"
          else
            WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
            echo "Using PRODUCTION webhook"
          fi
          
          TITLE="$TITLE" DESC="$DESC" COLOR="$COLOR" TIMESTAMP="$TIMESTAMP" THUMB="$THUMB" python3 /tmp/discord_script.py
          
          curl -f -X POST "$WEBHOOK_URL" \
               -H "Content-Type: application/json" \
               --data-binary @/tmp/discord_payload.json
          
          echo "‚úÖ Message sent!"
          echo "ü§ñ AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"

      - name: Test Mode Output
        if: ${{ github.event.inputs.test_mode == 'true' }}
        run: |
          echo "üß™ TEST MODE - Message preview:"
          echo "================================"
          echo "Title: ${{ steps.ai_generation.outputs.TITLE }}"
          echo "Description: ${{ steps.ai_generation.outputs.DESC_RAW }}"
          echo "AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "Context: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.SPECIAL_CONTEXT }})"
          echo "OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          if [[ "${{ github.event.inputs.use_test_webhook }}" == "true" ]]; then
            echo "Webhook: TEST"
          else
            echo "Webhook: PRODUCTION"
          fi
          echo "================================"
          echo "üß™ Test complete - no message sent"

      - name: Send Random Sticker
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "üé≤ Sending random sticker..."
          
          if [[ "${{ steps.context.outputs.OPENWRT_MODE }}" == "true" ]]; then
            echo "üè† OpenWrt mode - sending sticker immediately"
            sleep 1
          else
            echo "‚è∞ Standard delay for sticker..."
            sleep 3
          fi
          
          if [[ "${{ github.event.inputs.use_test_webhook }}" == "true" ]]; then
            WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_TEST }}"
          else
            WEBHOOK_URL="${{ secrets.Discord_WEBHOOK_URL }}"
            WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi
          
          if [[ "${{ steps.context.outputs.TYPE }}" == "morning" ]]; then
            STICKER="https://media.discordapp.net/stickers/1404543938815197306.png"
          elif [[ "${{ steps.context.outputs.TYPE }}" == "afternoon" ]]; then
            STICKER="https://media.discordapp.net/stickers/1405487683526201404.png"
          elif [[ "${{ steps.context.outputs.TYPE }}" == "evening" ]]; then
            STICKER="https://media.discordapp.net/stickers/1405914196922597549.png"
          else
            STICKER="https://media.discordapp.net/stickers/1406668584335184003.png"
          fi
          
          curl -f -X POST "$WEBHOOK_URL" \
               -H "Content-Type: application/json" \
               -d "{\"content\":\"$STICKER\"}"
          
          echo "üéâ Sticker sent!"

      - name: Execution Summary
        run: |
          echo "üìä EXECUTION SUMMARY"
          echo "================================"
          echo "üïê Time: ${{ steps.context.outputs.CURRENT_TIME }} WIB (${{ steps.context.outputs.CURRENT_DAY }})"
          echo "üéØ Type: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.CONTEXT }})"
          echo "üå§Ô∏è Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "ü§ñ AI Success: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "üè† OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          echo "üß™ Test Mode: ${{ github.event.inputs.test_mode }}"
          if [[ "${{ github.event.inputs.use_test_webhook }}" == "true" ]]; then
            echo "üîÑ Using TEST webhook"
          else
            echo "üîÑ Using PRODUCTION webhook"
          fi
          echo "================================"
          echo "‚úÖ Skye community greeting complete!"
