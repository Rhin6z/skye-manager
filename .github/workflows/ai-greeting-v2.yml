name: Skye Community AI Greeting

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'Source (openwrt/manual/test)'
        required: false
        default: 'manual'
        type: string
      greeting_type:
        description: 'Greeting type'
        required: false
        default: 'auto'
        type: choice
        options: [auto, morning, afternoon, evening, night]
      force_weather:
        description: 'Force weather check'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Test mode'
        required: false
        default: false
        type: boolean

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    
    steps:
      - name: Setup Context
        id: context
        run: |
          export TZ='Asia/Jakarta'
          
          OPENWRT_MODE=false
          if command -v opkg >/dev/null 2>&1 || [[ -f /etc/openwrt_release ]] || [[ "${{ github.event.inputs.trigger_source }}" == "openwrt" ]]; then
            OPENWRT_MODE=true
            echo "üè† OpenWrt detected - optimized timing mode"
          fi
          
          CURRENT_DAY=$(date +%A)
          CURRENT_DATE=$(date +"%B %d, %Y")
          CURRENT_TIME=$(date +"%H:%M")
          HOUR=$(date +%H | sed 's/^0*//')
          DAY_NUM=$(date +%u)
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MANUAL_TYPE="${{ github.event.inputs.greeting_type }}"
            if [[ "$MANUAL_TYPE" == "auto" ]]; then
              if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
                TYPE="morning"
              elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
                TYPE="afternoon" 
              elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
                TYPE="evening"
              else
                TYPE="night"
              fi
            else
              TYPE="$MANUAL_TYPE"
            fi
          else
            if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
              TYPE="morning"
            elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
              TYPE="afternoon" 
            elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
              TYPE="evening"
            else
              TYPE="night"
            fi
          fi
          
          if [[ $DAY_NUM -eq 6 || $DAY_NUM -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          SPECIAL_CONTEXT=""
          case "$CURRENT_DAY" in
            "Monday") SPECIAL_CONTEXT="monday_motivation" ;;
            "Wednesday") SPECIAL_CONTEXT="hump_day" ;;
            "Friday") SPECIAL_CONTEXT="weekend_countdown" ;;
            "Sunday") SPECIAL_CONTEXT="sunday_prep" ;;
          esac
          
          echo "TYPE=$TYPE" >> $GITHUB_OUTPUT
          echo "CONTEXT=$CONTEXT" >> $GITHUB_OUTPUT
          echo "CURRENT_DAY=$CURRENT_DAY" >> $GITHUB_OUTPUT
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "SPECIAL_CONTEXT=$SPECIAL_CONTEXT" >> $GITHUB_OUTPUT
          echo "DAY_NUM=$DAY_NUM" >> $GITHUB_OUTPUT
          echo "OPENWRT_MODE=$OPENWRT_MODE" >> $GITHUB_OUTPUT
          
          echo "üéØ Context: $TYPE on $CURRENT_DAY ($SPECIAL_CONTEXT)"

      - name: Get Weather (BMKG Yogyakarta)
        id: weather
        run: |
          WEATHER_INFO=""
          echo "üå§Ô∏è Fetching BMKG weather for Yogyakarta..."
          
          BMKG_RAW=$(curl -s "https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=34.04.07.2001" --connect-timeout 8 --max-time 15 || echo "")
            
          if [[ -n "$BMKG_RAW" && "$BMKG_RAW" != *"error"* && "$BMKG_RAW" != *"Error"* ]]; then
            echo "‚úÖ BMKG API response received"
            
            TEMP=$(echo "$BMKG_RAW" | grep -o '"t":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            DESC=$(echo "$BMKG_RAW" | grep -o '"weather_desc":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [[ -n "$TEMP" || -n "$DESC" ]]; then
              echo "üå°Ô∏è Raw: $TEMP¬∞C | $DESC"
              
              WEATHER_CASUAL=""
              if [[ -n "$DESC" ]]; then
                DESC_LOWER=$(echo "$DESC" | tr '[:upper:]' '[:lower:]')
                
                if [[ "$DESC_LOWER" == *"hujan"* || "$DESC_LOWER" == *"rain"* ]]; then
                  WEATHER_CASUAL="hujan"
                elif [[ "$DESC_LOWER" == *"gerimis"* || "$DESC_LOWER" == *"drizzle"* ]]; then
                  WEATHER_CASUAL="gerimis"
                elif [[ "$DESC_LOWER" == *"panas"* || "$DESC_LOWER" == *"hot"* || "$DESC_LOWER" == *"terik"* ]]; then
                  WEATHER_CASUAL="panas"
                elif [[ "$DESC_LOWER" == *"dingin"* || "$DESC_LOWER" == *"cold"* ]]; then
                  WEATHER_CASUAL="dingin"
                elif [[ "$DESC_LOWER" == *"sejuk"* || "$DESC_LOWER" == *"cool"* || "$DESC_LOWER" == *"adem"* ]]; then
                  WEATHER_CASUAL="sejuk"
                elif [[ "$DESC_LOWER" == *"berawan"* || "$DESC_LOWER" == *"cloudy"* ]]; then
                  WEATHER_CASUAL="berawan"
                elif [[ "$DESC_LOWER" == *"cerah"* || "$DESC_LOWER" == *"sunny"* || "$DESC_LOWER" == *"clear"* ]]; then
                  WEATHER_CASUAL="cerah"
                else
                  WEATHER_CASUAL="enak"
                fi
              fi
              
              if [[ -n "$TEMP" && -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL} ${TEMP}¬∞c"
              elif [[ -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL}"
              elif [[ -n "$TEMP" ]]; then
                WEATHER_INFO="${TEMP}¬∞c"
              fi
              
              echo "‚úÖ BMKG Weather: $WEATHER_INFO"
            else
              echo "‚ö†Ô∏è Could not extract weather data from BMKG response"
              WEATHER_INFO="cuaca enak"
            fi
          else
            echo "‚ùå BMKG API failed, using fallback"
            WEATHER_INFO="cuaca enak"
          fi
          
          echo "WEATHER_INFO=$WEATHER_INFO" >> $GITHUB_OUTPUT

      - name: Generate AI Greeting
        id: ai_generation
        run: |
          echo "ü§ñ Generating AI greeting..."
          
          cat > /tmp/prompt.txt << 'EOF'
          **role:** you are a hype admin for the indonesian gaming discord server "skye". your task is to write a daily greeting that feels authentic and engages the adult community.

          **inputs required**
          * {time} must be one of morning afternoon evening night
          * {weekday_or_weekend} must be weekday or weekend
          * {weather} short indonesian description like cerah mendung ringan gerimis panas terik

          **hard rules**
          1. write exactly two sentences total
          2. sentence one is one hundred percent english
          3. sentence two is about eighty percent indonesian you may mix game names or gamer slang in english
          4. all lowercase only max two emojis if they fit
          5. mild friendly toxicity allowed but keep it chill
          6. if {weekday_or_weekend} is weekend include the role tag <@&1374047008829997157> inside sentence two naturally on weekday do not include any tag the sentence structure must stay identical
          7. weave {weather} naturally as a reason in sentence two
          8. never use any dash characters in the generated message this includes minus hyphen and long dash
          9. keep it creative and avoid repeating patterns

          **structure**
          sentence one in english do all of these
          * start with a hype opener choose one yoooo wasuiiip heyyy sup oi ayokkk yo team aight okay okay heads up
          * ask a specific question about their current vibe or activity that matches {time}
          * keep it punchy around ten to eighteen words

          time specific ideas for sentence one pick one idea and vary daily
          * morning coffee or controller which quest are you speedrunning before work grabs you
          * afternoon post lunch queue or nap what is your quick match while digesting
          * evening chores done who is queueing a chill stack for the golden hour
          * night night crew which comp is farming your sanity till reset

          sentence two in indonesian about eighty percent do all of these
          * start with one of yuk gas ayo pada mau siapa mau
          * suggest an activity that fits {time}
            morning contoh ngopi dulu plus warm up aim lima belas menit daily quest tipis stretching ringan lalu deathmatch dua ronde
            afternoon contoh quick match lima belas sampai dua puluh menit roblox party santai aram tiga ronde
            evening contoh jalan sore tipis lanjut valo custom push rank santuy mabar ml role rapi biar tidak ribut
            night contoh vc sambil grind weekly scrim best of 3 co op roblox atau party games buat ketawa
          * weave {weather} as the reason contoh cuaca {weather} jadi pas buat
          * if weekend insert <@&1374047008829997157> naturally inside this sentence

          **formatting guardrails**
          * do casual friendly slightly hype
          * do not write hello how are you or any generic greeting
          * do not spam emojis or punctuation

          **output format required**
          context: {time} on a {weekday_or_weekend}
          weather: {weather}

          [your generated message here]

          **examples**

          context: morning on a weekday
          weather: cerah

          heyyy morning squad, coffee or controller which quest are you speedrunning before life aggro hits?
          yuk ngopi dulu sambil warm up aim lima belas menit, cuaca cerah bikin fokus jadi ayo colong daily üéÆ

          context: afternoon on a weekday
          weather: panas terik

          sup noon warriors, anyone queueuing a quick match while the food coma timer ticks?
          ayo quick match lima belas sampai dua puluh menit, panas terik mending ngadem aram tiga ronde atau roblox party

          context: evening on a weekend
          weather: mendung ringan

          yoooo evening crew, who is logging in for a chill stack after errands are done?
          gas jalan sore tipis lalu lanjut valo custom, mendung ringan bikin adem jadi <@&1374047008829997157> masuk vc satu bentar toxic dikit boleh

          context: night on a weekday
          weather: gerimis

          oi night shift, which comp is eating your elo till the reset hits?
          pada mau grind weekly sambil vc, gerimis pas banget buat mabar ml role rapi target tiga win sebelum tidur ‚òï
          EOF
          
          sed -i "s/TYPE_PLACEHOLDER/${{ steps.context.outputs.TYPE }}/g" /tmp/prompt.txt
          sed -i "s/CONTEXT_PLACEHOLDER/${{ steps.context.outputs.CONTEXT }}/g" /tmp/prompt.txt
          sed -i "s/WEATHER_INFO_PLACEHOLDER/${{ steps.weather.outputs.WEATHER_INFO }}/g" /tmp/prompt.txt
          
          AI_SUCCESS=false
          
          python3 << 'PYTHON_EOF'
          import json
          import requests
          import os
          import sys
          import re
          
          try:
              with open('/tmp/prompt.txt', 'r') as f:
                  prompt = f.read().strip()
              
              api_key = os.environ.get('GEMINI_API_KEY')
              if not api_key:
                  sys.exit(1)
              
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key={api_key}"
              
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "generationConfig": {
                      "temperature": 0.85,
                      "maxOutputTokens": 200,
                      "topP": 0.9
                  }
              }
              
              response = requests.post(url, json=payload, timeout=25)
              
              if response.status_code == 200:
                  data = response.json()
                  if 'candidates' in data and len(data['candidates']) > 0:
                      ai_text = data['candidates'][0]['content']['parts'][0]['text'].strip()
                      
                      # Clean and extract the message
                      clean_text = re.sub(r'\*\*([^*]+)\*\*', r'\1', ai_text)
                      clean_text = re.sub(r'\*([^*]+)\*', r'\1', clean_text)
                      clean_text = re.sub(r'`([^`]+)`', r'\1', clean_text)
                      
                      # Find the best line (longest substantial content)
                      lines = [line.strip() for line in clean_text.split('\n') if line.strip()]
                      best_line = ""
                      
                      for line in lines:
                          if (len(line) > 30 and 
                              not line.startswith(('**', '#', '-', '*', 'Context:', 'Weather:', 'SENTENCE', 'TIME-BASED')) and
                              not line.lower().startswith(('greeting:', 'message:', 'response:', 'output:'))):
                              if len(line) > len(best_line):
                                  best_line = line
                      
                      if best_line:
                          with open('/tmp/ai_response.txt', 'w', encoding='utf-8') as f:
                              f.write(best_line)
                          print("‚úÖ AI generation successful")
                          sys.exit(0)
              
              sys.exit(1)
              
          except Exception as e:
              print(f"‚ùå AI generation failed: {e}")
              sys.exit(1)
          PYTHON_EOF
          
          if [[ $? -eq 0 && -s /tmp/ai_response.txt ]]; then
            AI_TEXT=$(cat /tmp/ai_response.txt)
            WEATHER_MENTION="${{ steps.weather.outputs.WEATHER_INFO }}"
            echo "üéØ AI generated: $AI_TEXT"
            
            # Strict validation for proper 2-sentence English-Indonesian structure
            SENTENCE_COUNT=$(echo "$AI_TEXT" | grep -o '[.!?]' | wc -l)
            
            # Check for English greeting at the start
            HAS_ENGLISH_START=$(echo "$AI_TEXT" | grep -iE "^(yooo|wassup|heyyyy|sup|ayooo)")
            
            # Check for Indonesian invitation words  
            HAS_INDONESIAN=$(echo "$AI_TEXT" | grep -iE "(yuk|siapa mau|gas|ayo)")
            
            # Check for gaming activities
            HAS_ACTIVITY=$(echo "$AI_TEXT" | grep -iE "(mabar|valo|valorant|ml|mobile legends|roblox|gaming|game|voice chat|push rank|nongkrong|begadang)")
            
            # Check for weather mention
            HAS_WEATHER=$(echo "$AI_TEXT" | grep -iE "(cuaca|${WEATHER_MENTION//cuaca /})")
            
            # Check for proper sentence separation (. or ? followed by space and word)
            HAS_SENTENCE_BREAK=$(echo "$AI_TEXT" | grep -E '[.?]\s+[a-z]')
            
            # Strict validation - must have all components
            if [[ ${#AI_TEXT} -gt 70 && ${#AI_TEXT} -lt 280 && $SENTENCE_COUNT -ge 2 && -n "$HAS_ENGLISH_START" && -n "$HAS_INDONESIAN" && -n "$HAS_ACTIVITY" && -n "$HAS_WEATHER" && -n "$HAS_SENTENCE_BREAK" ]]; then
              DESC_RAW="$AI_TEXT"
              USE_AI=true
              echo "‚úÖ AI validated: ${#AI_TEXT} chars, proper English-Indonesian structure"
            else
              echo "‚ö†Ô∏è AI validation failed: ${#AI_TEXT} chars"
              echo "   English start: ${HAS_ENGLISH_START:-missing}"
              echo "   Indonesian: ${HAS_INDONESIAN:-missing}" 
              echo "   Activity: ${HAS_ACTIVITY:-missing}"
              echo "   Weather: ${HAS_WEATHER:-missing}"
              echo "   Sentence break: ${HAS_SENTENCE_BREAK:-missing}"
              echo "   Sentence count: $SENTENCE_COUNT"
              echo "   Raw text: $AI_TEXT"
              USE_AI=false
            fi
          else
            echo "‚ùå AI generation failed, using fallback"
            USE_AI=false
          fi
          
          if [[ "$USE_AI" != "true" ]]; then
            echo "üé≤ Using enhanced fallback system..."
            
            WEATHER_MENTION="${{ steps.weather.outputs.WEATHER_INFO }}"
            declare -a MESSAGES
            
            case "${{ steps.context.outputs.TYPE }}" in
              "morning")
                MESSAGES=(
                  "yooooo morning squad, how's everyone feeling this early? yuk <@&1374047008829997157> olahraga pagi terus sarapan sambil ngobrol, ${WEATHER_MENTION} enak nih!"
                  "wassuppp early birds, energy level gimana pagi ini? siapa mau jogging bareng <@&1374047008829997157> terus main roblox santai, ${WEATHER_MENTION}?"
                  "heyyyy morning legends, udah bangun sempurna atau masih zombie mode? gas <@&1374047008829997157> stretching dulu terus gaming session, ${WEATHER_MENTION}"
                  "sup good morning gamers, feeling fresh atau masih ngantuk parah? yuk <@&1374047008829997157> jalan-jalan pagi sambil planning hari ini, ${WEATHER_MENTION}!"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yooooo morning squad, how's everyone feeling this early? yuk olahraga pagi terus sarapan sambil ngobrol, ${WEATHER_MENTION} enak nih!"
                    "wassuppp early birds, energy level gimana pagi ini? siapa mau jogging bareng terus main roblox santai, ${WEATHER_MENTION}?"
                    "heyyyy morning legends, udah bangun sempurna atau masih zombie mode? gas stretching dulu terus gaming session, ${WEATHER_MENTION}"
                    "sup good morning gamers, feeling fresh atau masih ngantuk parah? yuk jalan-jalan pagi sambil planning hari ini, ${WEATHER_MENTION}!"
                  )
                fi
                ;;
              "afternoon")
                MESSAGES=(
                  "yooooo afternoon vibes, how's the day treating everyone so far? yuk <@&1374047008829997157> makan siang bareng terus mabar ml, ${WEATHER_MENTION} nih!"
                  "wassuppp midday squad, productive day atau masih males-malesan? siapa mau nongkrong <@&1374047008829997157> sambil chill gaming, ${WEATHER_MENTION}?"
                  "heyyyy afternoon legends, udah lunch atau masih sibuk banget? gas <@&1374047008829997157> ke mall terus main roblox, ${WEATHER_MENTION}"
                  "sup afternoon crew, capek atau masih semangat full? ayo <@&1374047008829997157> hangout sambil push rank, ${WEATHER_MENTION}!"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yooooo afternoon vibes, how's the day treating everyone so far? yuk makan siang bareng terus mabar ml, ${WEATHER_MENTION} nih!"
                    "wassuppp midday squad, productive day atau masih males-malesan? siapa mau nongkrong sambil chill gaming, ${WEATHER_MENTION}?"
                    "heyyyy afternoon legends, udah lunch atau masih sibuk banget? gas ke warteg terus main roblox, ${WEATHER_MENTION}"
                    "sup afternoon crew, capek atau masih semangat full? ayo santai sambil push rank, ${WEATHER_MENTION}!"
                  )
                fi
                ;;
              "evening")
                MESSAGES=(
                  "yooooo evening squad, how was today overall gimana? winding down <@&1374047008829997157> dinner bareng terus voice chat, ${WEATHER_MENTION} nih!"
                  "wassuppp golden hour gang, tired atau masih energetic banget? siapa mau <@&1374047008829997157> nongkrong terus mabar valo, ${WEATHER_MENTION}?"
                  "heyyyy evening legends, day was good atau challenging abis? perfect time <@&1374047008829997157> makan malem sambil gaming, ${WEATHER_MENTION}"
                  "sup evening mood check, dinner udah atau masih nyari makan? yuk <@&1374