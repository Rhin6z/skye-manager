name: Skye Community AI Greeting

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'Source (openwrt/manual/test)'
        required: false
        default: 'manual'
        type: string
      greeting_type:
        description: 'Greeting type'
        required: false
        default: 'auto'
        type: choice
        options: [auto, morning, afternoon, evening, night]
      force_weather:
        description: 'Force weather check'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Test mode'
        required: false
        default: false
        type: boolean

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    
    steps:
      - name: Setup Context
        id: context
        run: |
          export TZ='Asia/Jakarta'
          
          OPENWRT_MODE=false
          if command -v opkg >/dev/null 2>&1 || [[ -f /etc/openwrt_release ]] || [[ "${{ github.event.inputs.trigger_source }}" == "openwrt" ]]; then
            OPENWRT_MODE=true
            echo "üè† OpenWrt detected - optimized timing mode"
          fi
          
          CURRENT_DAY=$(date +%A)
          CURRENT_DATE=$(date +"%B %d, %Y")
          CURRENT_TIME=$(date +"%H:%M")
          HOUR=$(date +%H | sed 's/^0*//')
          DAY_NUM=$(date +%u)
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MANUAL_TYPE="${{ github.event.inputs.greeting_type }}"
            if [[ "$MANUAL_TYPE" == "auto" ]]; then
              if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
                TYPE="morning"
              elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
                TYPE="afternoon" 
              elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
                TYPE="evening"
              else
                TYPE="night"
              fi
            else
              TYPE="$MANUAL_TYPE"
            fi
          else
            if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
              TYPE="morning"
            elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
              TYPE="afternoon" 
            elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
              TYPE="evening"
            else
              TYPE="night"
            fi
          fi
          
          if [[ $DAY_NUM -eq 6 || $DAY_NUM -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          SPECIAL_CONTEXT=""
          case "$CURRENT_DAY" in
            "Monday") SPECIAL_CONTEXT="monday_motivation" ;;
            "Wednesday") SPECIAL_CONTEXT="hump_day" ;;
            "Friday") SPECIAL_CONTEXT="weekend_countdown" ;;
            "Sunday") SPECIAL_CONTEXT="sunday_prep" ;;
          esac
          
          echo "TYPE=$TYPE" >> $GITHUB_OUTPUT
          echo "CONTEXT=$CONTEXT" >> $GITHUB_OUTPUT
          echo "CURRENT_DAY=$CURRENT_DAY" >> $GITHUB_OUTPUT
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "SPECIAL_CONTEXT=$SPECIAL_CONTEXT" >> $GITHUB_OUTPUT
          echo "DAY_NUM=$DAY_NUM" >> $GITHUB_OUTPUT
          echo "OPENWRT_MODE=$OPENWRT_MODE" >> $GITHUB_OUTPUT
          
          echo "üéØ Context: $TYPE on $CURRENT_DAY ($SPECIAL_CONTEXT)"

      - name: Get Weather (BMKG Yogyakarta)
        id: weather
        run: |
          WEATHER_INFO=""
          echo "üå§Ô∏è Fetching BMKG weather for Yogyakarta..."
          
          BMKG_RAW=$(curl -s "https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=34.04.07.2001" --connect-timeout 8 --max-time 15 || echo "")
            
          if [[ -n "$BMKG_RAW" && "$BMKG_RAW" != *"error"* && "$BMKG_RAW" != *"Error"* ]]; then
            echo "‚úÖ BMKG API response received"
            
            TEMP=$(echo "$BMKG_RAW" | grep -o '"t":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            DESC=$(echo "$BMKG_RAW" | grep -o '"weather_desc":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [[ -n "$TEMP" || -n "$DESC" ]]; then
              echo "üå°Ô∏è Raw: $TEMP¬∞C | $DESC"
              
              WEATHER_CASUAL=""
              if [[ -n "$DESC" ]]; then
                DESC_LOWER=$(echo "$DESC" | tr '[:upper:]' '[:lower:]')
                
                if [[ "$DESC_LOWER" == *"hujan"* || "$DESC_LOWER" == *"rain"* ]]; then
                  WEATHER_CASUAL="hujan"
                elif [[ "$DESC_LOWER" == *"gerimis"* || "$DESC_LOWER" == *"drizzle"* ]]; then
                  WEATHER_CASUAL="gerimis"
                elif [[ "$DESC_LOWER" == *"panas"* || "$DESC_LOWER" == *"hot"* || "$DESC_LOWER" == *"terik"* ]]; then
                  WEATHER_CASUAL="panas"
                elif [[ "$DESC_LOWER" == *"dingin"* || "$DESC_LOWER" == *"cold"* ]]; then
                  WEATHER_CASUAL="dingin"
                elif [[ "$DESC_LOWER" == *"sejuk"* || "$DESC_LOWER" == *"cool"* || "$DESC_LOWER" == *"adem"* ]]; then
                  WEATHER_CASUAL="sejuk"
                elif [[ "$DESC_LOWER" == *"berawan"* || "$DESC_LOWER" == *"cloudy"* ]]; then
                  WEATHER_CASUAL="berawan"
                elif [[ "$DESC_LOWER" == *"cerah"* || "$DESC_LOWER" == *"sunny"* || "$DESC_LOWER" == *"clear"* ]]; then
                  WEATHER_CASUAL="cerah"
                else
                  WEATHER_CASUAL="enak"
                fi
              fi
              
              if [[ -n "$TEMP" && -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL} ${TEMP}¬∞c"
              elif [[ -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL}"
              elif [[ -n "$TEMP" ]]; then
                WEATHER_INFO="${TEMP}¬∞c"
              fi
              
              echo "‚úÖ BMKG Weather: $WEATHER_INFO"
            else
              echo "‚ö†Ô∏è Could not extract weather data from BMKG response"
              WEATHER_INFO="cuaca enak"
            fi
          else
            echo "‚ùå BMKG API failed, using fallback"
            WEATHER_INFO="cuaca enak"
          fi
          
          echo "WEATHER_INFO=$WEATHER_INFO" >> $GITHUB_OUTPUT

      - name: Generate AI Greeting
        id: ai_generation
        run: |
          echo "ü§ñ Generating AI greeting..."
          
          # Create special context prompt addition if applicable
          SPECIAL_PROMPT=""
          if [[ -n "${{ steps.context.outputs.SPECIAL_CONTEXT }}" ]]; then
            case "${{ steps.context.outputs.SPECIAL_CONTEXT }}" in
              "monday_motivation")
                SPECIAL_PROMPT="- Include motivation for the week ahead or Monday energy vibes"
                ;;
              "hump_day")
                SPECIAL_PROMPT="- Mention mid-week energy or halfway to weekend vibes"
                ;;
              "weekend_countdown")
                SPECIAL_PROMPT="- Celebrate approaching weekend or Friday feeling"
                ;;
              "sunday_prep")
                SPECIAL_PROMPT="- Reference preparing for the week ahead or enjoying the last of weekend"
                ;;
            esac
          fi
          
          cat > /tmp/prompt.txt << 'EOF'
          **CONTEXT FOR THIS MESSAGE:**
          - Time: ${{ steps.context.outputs.TYPE }}
          - Day: ${{ steps.context.outputs.CURRENT_DAY }} (${{ steps.context.outputs.CONTEXT }})
          - Weather: ${{ steps.weather.outputs.WEATHER_INFO }}
          $SPECIAL_PROMPT
          
          **ROLE:** You are a hype admin for Indonesian gaming Discord server "Skye". Write a daily greeting.
          
          **CRITICAL FORMAT REQUIREMENT - MUST FOLLOW EXACTLY:**
          Write exactly TWO complete sentences separated by a space:
          
          SENTENCE 1 (English only):
          - Start with hype opener: yoooow, wassuuup, heyyyyyy, suuuup, oiiiii, ayooooo, yoohoooo
          - Ask engaging question about current vibe/activity matching the time and DAY OF WEEK
          - Use CORRECT day of week (${{ steps.context.outputs.CURRENT_DAY }})
          - End with question mark
          - 10-18 words total
          
          SENTENCE 2 (Indonesian with English game terms):
          - Start with invitation: yuuuk, gaskeun, gas polll, ayooook, hayuuuk, pada mauuu gak, siapaaaa yang mau
          - Suggest activity fitting time + weather
          - Include weather as reason naturally
          - If weekend, include <@&1374047008829997157> tag naturally
          - No tag on weekdays
          - End with matching emoji
          
          **TIME-SPECIFIC SUGGESTIONS:**
          - Morning: coffee/breakfast vibes, warm-up games, daily quests, aim practice
          - Afternoon: lunch breaks, quick matches, mid-day grinding
          - Evening: after-work/school gaming, dinner and gaming, ranked push
          - Night: late night grinding, tournament practice, chill sessions
          
          **WEATHER-SPECIFIC SUGGESTIONS:**
          - Rain: cozy indoor gaming, focus time, ranked grinding with rain sounds
          - Hot: AC gaming, chill mode, staying cool with games
          - Cold: warming up with intense matches, cozy gaming sessions
          - Clear: energetic gaming, perfect focus conditions
          
          **EXAMPLES:**
          yoooow morning squad, coffee or controller which quest are you tackling this wednesday? ayooook ngopi dulu sambil warm up aim, cuaca cerah bikin fokus jadi perfect buat daily quest üéÆ
          
          heyyyyyy afternoon crew, post lunch energy hitting different or still food coma mode? gaskeun quick match ml sambil ngadem, cuaca panas bikin mager jadi mending ranked push di AC ‚òï
          
          **RULES:**
          - All lowercase 
          - Max 2 emojis
          - No dashes/hyphens
          - Weather must match activity suggestions
          - Must be creative, avoid templates
          - ALWAYS use correct day name from context
          
          Write the greeting now:
          EOF
          
          python3 << 'PYTHON_EOF'
          import json
          import requests
          import os
          import sys
          import re
          
          try:
              with open('/tmp/prompt.txt', 'r') as f:
                  prompt = f.read().strip()
              
              api_key = os.environ.get('GEMINI_API_KEY')
              if not api_key:
                  print("‚ùå No API key")
                  sys.exit(1)
              
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key={api_key}"
              
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "generationConfig": {
                      "temperature": 0.8,
                      "maxOutputTokens": 150,
                      "topP": 0.9
                  }
              }
              
              response = requests.post(url, json=payload, timeout=20)
              
              if response.status_code == 200:
                  data = response.json()
                  if 'candidates' in data and len(data['candidates']) > 0:
                      ai_text = data['candidates'][0]['content']['parts'][0]['text'].strip()
                      
                      # Clean formatting
                      clean_text = re.sub(r'\*\*([^*]+)\*\*', r'\1', ai_text)
                      clean_text = re.sub(r'`([^`]+)`', r'\1', clean_text)
                      clean_text = re.sub(r'\n+', ' ', clean_text)
                      clean_text = ' '.join(clean_text.split())
                      
                      # Find actual greeting (not metadata)
                      lines = [line.strip() for line in ai_text.split('\n') if line.strip()]
                      best_line = ""
                      
                      for line in lines:
                          if (len(line) > 50 and 
                              not line.startswith(('**', '#', '-', '*', 'Context:', 'Weather:', 'Time:', 'Day:')) and
                              not line.lower().startswith(('greeting:', 'message:', 'response:', 'output:', 'here'))) :
                              if ('?' in line and 
                                  any(word in line.lower() for word in ['yuk', 'gas', 'ayo', 'pada', 'siapa', 'hayuk', 'gaskeun']) and
                                  any(word in line.lower() for word in ['yooo', 'wassup', 'heyyy', 'sup', 'oi', 'ayok', 'yo', 'oiii', 'hello'])):
                                  best_line = line
                                  break
                      
                      if not best_line and clean_text:
                          best_line = clean_text
                      
                      if best_line and len(best_line) > 50:
                          with open('/tmp/ai_response.txt', 'w', encoding='utf-8') as f:
                              f.write(best_line)
                          print("‚úÖ AI generation successful")
                          sys.exit(0)
              
              print("‚ùå AI generation failed - invalid response")
              sys.exit(1)
              
          except Exception as e:
              print(f"‚ùå AI generation failed: {e}")
              sys.exit(1)
          PYTHON_EOF
          
          if [[ $? -eq 0 && -s /tmp/ai_response.txt ]]; then
            AI_TEXT=$(cat /tmp/ai_response.txt)
            echo "üéØ AI generated: $AI_TEXT"
            
            # Validation
            SENTENCE_COUNT=$(echo "$AI_TEXT" | grep -o '[.!?]' | wc -l)
            HAS_ENGLISH_START=$(echo "$AI_TEXT" | grep -iE "^(yooo|wassup|heyyy|sup|oi|ayok|yo|oiii|hello)" || echo "")
            HAS_INDONESIAN=$(echo "$AI_TEXT" | grep -iE "(yuk|siapa mau|gas|ayo|pada mau|hayuk|gaskeun)" || echo "")
            HAS_WEATHER=$(echo "$AI_TEXT" | grep -iE "(cuaca|hujan|gerimis|cerah|panas|dingin|sejuk|berawan|mendung)" || echo "")
            HAS_QUESTION=$(echo "$AI_TEXT" | grep -E "\?" || echo "")
            
            # Day validation
            DAY_VALIDATION=$(echo "$AI_TEXT" | grep -iE "(monday|tuesday|wednesday|thursday|friday|saturday|sunday)" || echo "")
            DAY_CORRECT=true
            if [[ -n "$DAY_VALIDATION" ]]; then
              CURRENT_DAY_LOWER=$(echo "${{ steps.context.outputs.CURRENT_DAY }}" | tr '[:upper:]' '[:lower:]')
              if [[ ! "$DAY_VALIDATION" =~ "$CURRENT_DAY_LOWER" ]]; then
                echo "‚ö†Ô∏è Day inconsistency detected in AI response!"
                DAY_CORRECT=false
              fi
            fi
            
            if [[ ${#AI_TEXT} -gt 60 && ${#AI_TEXT} -lt 300 && $SENTENCE_COUNT -ge 1 && -n "$HAS_ENGLISH_START" && -n "$HAS_INDONESIAN" && -n "$HAS_WEATHER" && -n "$HAS_QUESTION" && "$DAY_CORRECT" == "true" ]]; then
              DESC_RAW="$AI_TEXT"
              USE_AI=true
              echo "‚úÖ AI validated: ${#AI_TEXT} chars"
            else
              echo "‚ö†Ô∏è AI validation failed"
              echo "   Length: ${#AI_TEXT} chars"
              echo "   English start: ${HAS_ENGLISH_START:-missing}"
              echo "   Indonesian: ${HAS_INDONESIAN:-missing}" 
              echo "   Weather: ${HAS_WEATHER:-missing}"
              echo "   Question: ${HAS_QUESTION:-missing}"
              echo "   Day correct: ${DAY_CORRECT}"
              USE_AI=false
            fi
          else
            echo "‚ùå AI generation failed, using fallback"
            USE_AI=false
          fi
          
          if [[ "$USE_AI" != "true" ]]; then
            echo "üé≤ Using fallback system..."
            
            WEATHER_MENTION="${{ steps.weather.outputs.WEATHER_INFO }}"
            declare -a MESSAGES
            
            case "${{ steps.context.outputs.TYPE }}" in
              "morning")
                MESSAGES=(
                  "yoooow morning squad, coffee hitting different or controller calling your name already? yuuuk <@&1374047008829997157> ngopi sambil warm up aim dulu, ${WEATHER_MENTION} perfect buat fokus grinding! ‚òï"
                  "wassuuuup early birds, energy level udah full atau masih butuh caffeine boost? gaskeun <@&1374047008829997157> sarapan sambil daily quest ringan, ${WEATHER_MENTION} bikin mood enak buat main! üéÆ"
                  "heyyyyyy morning legends, dreams about ranked or nightmares about losing streak? ayooook <@&1374047008829997157> stretching dulu terus langsung gaming, ${WEATHER_MENTION} cocok banget! üî•"
                  "oiiiii morning crew, ready to conquer today atau masih half asleep mode? gas polll <@&1374047008829997157> planning strategy sambil ngopi, ${WEATHER_MENTION} enak nih! üåû"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow morning squad, coffee hitting different or controller calling your name already? yuuuk ngopi sambil warm up aim dulu, ${WEATHER_MENTION} perfect buat fokus grinding! ‚òï"
                    "wassuuuup early birds, energy level udah full atau masih butuh caffeine boost? gaskeun sarapan sambil daily quest ringan, ${WEATHER_MENTION} bikin mood enak buat main! üéÆ"
                    "heyyyyyy morning legends, dreams about ranked or nightmares about losing streak? ayooook stretching dulu terus langsung gaming, ${WEATHER_MENTION} cocok banget! üî•"
                    "oiiiii morning crew, ready to conquer today atau masih half asleep mode? gas polll planning strategy sambil ngopi, ${WEATHER_MENTION} enak nih! üåû"
                  )
                fi
                ;;
              "afternoon")
                MESSAGES=(
                  "yoooow afternoon vibes, lunch coma hitting atau energy masih tinggi banget? yuuuk <@&1374047008829997157> quick match ml sambil digest, ${WEATHER_MENTION} pas buat santai gaming! üéØ"
                  "wassuuuup midday squad, productivity tinggi atau udah mulai burnout? pada mauuu gak <@&1374047008829997157> aram party sambil ngobrol, ${WEATHER_MENTION} bikin pengen ngadem! üå§Ô∏è"
                  "heyyyyyy afternoon crew, grind mode on atau break time calling? gaskeun <@&1374047008829997157> push rank valo sambil makan siang, ${WEATHER_MENTION} enak banget! üçπ"
                  "suuuup afternoon legends, motivation still high atau udah weekend mode? siapaaaa yang mau <@&1374047008829997157> roblox party sambil chill, ${WEATHER_MENTION} perfect timing! üéÆ"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow afternoon vibes, lunch coma hitting atau energy masih tinggi banget? yuuuk quick match ml sambil digest, ${WEATHER_MENTION} pas buat santai gaming! üéØ"
                    "wassuuuup midday squad, productivity tinggi atau udah mulai burnout? pada mauuu gak aram party sambil ngobrol, ${WEATHER_MENTION} bikin pengen ngadem! üå§Ô∏è"
                    "heyyyyyy afternoon crew, grind mode on atau break time calling? gaskeun push rank valo sambil makan siang, ${WEATHER_MENTION} enak banget! üçπ"
                    "suuuup afternoon legends, motivation still high atau udah weekend mode? siapaaaa yang mau roblox party sambil chill, ${WEATHER_MENTION} perfect timing! üéÆ"
                  )
                fi
                ;;
              "evening")
                MESSAGES=(
                  "yoooow evening squad, day was productive atau disaster yang indah? gas polll <@&1374047008829997157> dinner sambil voice chat, ${WEATHER_MENTION} bikin mood relaxing! üåÜ"
                  "wassuuuup golden hour gang, winding down atau masih full energy? yuuuk <@&1374047008829997157> mabar ml sambil sunset vibes, ${WEATHER_MENTION} aesthetic banget! üéÆ"
                  "heyyyyyy evening crew, tired dari seharian atau ready for night session? hayuuuk <@&1374047008829997157> push rank sambil makan malam, ${WEATHER_MENTION} pas! üçú"
                  "ayooooo evening legends, chores done atau masih ada PR hidup? pada mauuu gak <@&1374047008829997157> gaming marathon prep, ${WEATHER_MENTION} cocok buat focus! üéØ"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow evening squad, day was productive atau disaster yang indah? gas polll dinner sambil voice chat, ${WEATHER_MENTION} bikin mood relaxing! üåÜ"
                    "wassuuuup golden hour gang, winding down atau masih full energy? yuuuk mabar ml sambil sunset vibes, ${WEATHER_MENTION} aesthetic banget! üéÆ"
                    "heyyyyyy evening crew, tired dari seharian atau ready for night session? hayuuuk push rank sambil makan malam, ${WEATHER_MENTION} pas! üçú"
                    "ayooooo evening legends, chores done atau masih ada PR hidup? pada mauuu gak gaming marathon prep, ${WEATHER_MENTION} cocok buat focus! üéØ"
                  )
                fi
                ;;
              "night")
                MESSAGES=(
                  "yoooow night owls, insomnia squad atau pilihan begadang for fun? yuuuk <@&1374047008829997157> marathon gaming sambil vibing, ${WEATHER_MENTION} enak buat late night session! üåô"
                  "wassuuuup midnight legends, peaceful hours atau chaos di ranked? siapaaaa yang mau <@&1374047008829997157> grind sampai pagi sambil ngobrol, ${WEATHER_MENTION} bikin betah! üéÆ"
                  "heyyyyyy nocturnal gamers, night hits different atau sama aja? gaskeun <@&1374047008829997157> push rank ml sampai subuh, ${WEATHER_MENTION} perfect buat focus! üå†"
                  "suuuup late night squad, bocil udah tidur semua nih freedom time! hayuuuk <@&1374047008829997157> party games sambil ketawa, ${WEATHER_MENTION} cocok buat chill! üéØ"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow night owls, insomnia squad atau pilihan begadang for fun? yuuuk marathon gaming sambil vibing, ${WEATHER_MENTION} enak buat late night session! üåô"
                    "wassuuuup midnight legends, peaceful hours atau chaos di ranked? siapaaaa yang mau grind sampai pagi sambil ngobrol, ${WEATHER_MENTION} bikin betah! üéÆ"
                    "heyyyyyy nocturnal gamers, night hits different atau sama aja? gaskeun push rank ml sampai subuh, ${WEATHER_MENTION} perfect buat focus! üå†"
                    "suuuup late night squad, bocil udah tidur semua nih freedom time! hayuuuk party games sambil ketawa, ${WEATHER_MENTION} cocok buat chill! üéØ"
                  )
                fi
                ;;
            esac
            
            # Add special context messages if applicable
            if [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "monday_motivation" ]]; then
              MESSAGES+=(
                "yoooow monday warriors, ready to conquer the week or still in weekend mode? yuuuk start dengan semangat sambil gaming, ${WEATHER_MENTION} cocok buat fresh start! üöÄ"
              )
            elif [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "hump_day" ]]; then
              MESSAGES+=(
                "wassuuuup wednesday crew, halfway to weekend vibes mulai kerasa? gas polll mid-week gaming session buat recharge, ${WEATHER_MENTION} pas banget buat midweek boost! üéÆ"
              )
            elif [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "weekend_countdown" ]]; then
              MESSAGES+=(
                "heyyyyyy friday squad, weekend energy udah mulai muncul? siapaaaa yang mau start weekend dengan victory streak, ${WEATHER_MENTION} perfect buat weekend countdown! üéâ"
              )
            elif [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "sunday_prep" ]]; then
              MESSAGES+=(
                "oiiiii sunday gamers, enjoying the last bits of weekend freedom? yuuuk maximal weekend fun sebelum monday, ${WEATHER_MENTION} bikin betah buat last day grinding! üåÖ"
              )
            fi
            
            RANDOM_INDEX=$((RANDOM % ${#MESSAGES[@]}))
            DESC_RAW="${MESSAGES[$RANDOM_INDEX]}"
          fi
          
          declare -a TITLES
          declare -a THUMBS
          
          case "${{ steps.context.outputs.TYPE }}" in
            "morning") 
              TITLES=("‚òÄÔ∏è Morning Skye Squad" "üåÖ Early Bird Energy" "‚òï Coffee & Gaming Time" "üåû Fresh Morning Vibes" "‚≠ê New Day New Games")
              THUMBS=("2600" "1f305" "2615" "1f31e" "2b50")
              ;;
            "afternoon") 
              TITLES=("üçÉ Afternoon Chill Mode" "üå§Ô∏è Midday Squad Check" "‚òÄÔ∏è Lunch Break Gaming" "üéØ Afternoon Focus Time" "üíº Productive Break")
              THUMBS=("1f343" "1f324" "2600" "1f3af" "1f4bc")
              ;;
            "evening") 
              TITLES=("üåá Evening Chill Squad" "üåÜ Golden Hour Gaming" "‚ú® Evening Wind-Down" "üåÖ Sunset Gaming Time" "üéØ Evening Focus Mode")
              THUMBS=("1f307" "1f307" "2728" "1f305" "1f3af")
              ;;
            "night") 
              TITLES=("ü¶â Late Night Squad" "üåô Midnight Gaming Club" "‚≠ê Night Owl Assembly" "‚ú® Nocturnal Gamers" "üåü Late Night Energy")
              THUMBS=("1f989" "1f319" "2b50" "2728" "1f31f")
              ;;
          esac
          
          RANDOM_INDEX=$((RANDOM % ${#TITLES[@]}))
          TITLE="${TITLES[$RANDOM_INDEX]}"
          THUMB="${THUMBS[$RANDOM_INDEX]}"
          
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "DESC_RAW=$DESC_RAW" >> $GITHUB_OUTPUT
          echo "USE_AI=$USE_AI" >> $GITHUB_OUTPUT
          echo "THUMB=$THUMB" >> $GITHUB_OUTPUT
          
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Send Discord Message
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "üì§ Sending Discord message..."
          
          case "${{ steps.context.outputs.TYPE }}" in
            "morning") COLOR=16766720 ;;
            "afternoon") COLOR=16763904 ;;
            "evening") COLOR=16744448 ;;
            "night") COLOR=8947848 ;;
          esac
          
          TITLE="${{ steps.ai_generation.outputs.TITLE }}"
          DESC="${{ steps.ai_generation.outputs.DESC_RAW }}"
          THUMB="${{ steps.ai_generation.outputs.THUMB }}"
          TIMESTAMP=$(TZ='Asia/Jakarta' date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          python3 << 'PYTHON_EOF'
          import json
          import os
          
          title = os.environ.get('TITLE', 'Skye Squad')
          desc_raw = os.environ.get('DESC', 'what\'s good everyone!')
          color = int(os.environ.get('COLOR', '16766720'))
          timestamp = os.environ.get('TIMESTAMP', '')
          thumb = os.environ.get('THUMB', '1f305')
          context = os.environ.get('CONTEXT', 'weekday')
          
          # Convert description to lowercase
          desc = desc_raw.lower()
          
          # Add signature
          desc += "\n> by server dev guanteng - <@399393175904714752>"
          
          embed = {
              "title": title,
              "description": desc,
              "color": color,
              "thumbnail": {
                  "url": f"https://twemoji.maxcdn.com/v/latest/72x72/{thumb}.png"
              },
              "footer": {
                  "text": "chill gaming vibes",
                  "icon_url": "https://files.catbox.moe/npfh4e.jpg"
              },
              "timestamp": timestamp
          }
          
          payload = {"embeds": [embed]}
          
          with open('/tmp/discord_payload.json', 'w', encoding='utf-8') as f:
              json.dump(payload, f, ensure_ascii=False)
          
          print("‚úÖ Payload created")
          PYTHON_EOF
          
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --data-binary @/tmp/discord_payload.json
          
          echo "‚úÖ Message sent!"
          echo "ü§ñ AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"
          
        env:
          TITLE: ${{ steps.ai_generation.outputs.TITLE }}
          DESC: ${{ steps.ai_generation.outputs.DESC_RAW }}
          COLOR: ${{ env.COLOR }}
          TIMESTAMP: ${{ env.TIMESTAMP }}
          THUMB: ${{ steps.ai_generation.outputs.THUMB }}
          CONTEXT: ${{ steps.context.outputs.CONTEXT }}

      - name: Test Mode Output
        if: ${{ github.event.inputs.test_mode == 'true' }}
        run: |
          echo "üß™ TEST MODE - Message preview:"
          echo "================================"
          echo "Title: ${{ steps.ai_generation.outputs.TITLE }}"
          echo "Description: ${{ steps.ai_generation.outputs.DESC_RAW }}"
          echo "AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "Context: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.SPECIAL_CONTEXT }})"
          echo "OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          echo "================================"
          echo "üß™ Test complete - no message sent"

      - name: Send Random Sticker
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "üé≤ Sending random sticker..."
          
          if [[ "${{ steps.context.outputs.OPENWRT_MODE }}" == "true" ]]; then
            echo "üè† OpenWrt mode - sending sticker immediately"
            sleep 1
          else
            echo "‚è∞ Standard delay for sticker..."
            sleep 3
          fi
          
          case "${{ steps.context.outputs.TYPE }}" in
            "morning")
              STICKERS=(
                "https://media.discordapp.net/stickers/1404543938815197306.png"
                "https://media.discordapp.net/stickers/1405277985237368943.png"
                "https://media.discordapp.net/stickers/1405477154095104082.png"
              )
              ;;
            "afternoon")
              STICKERS=(
                "https://media.discordapp.net/stickers/1405487683526201404.png"
                "https://media.discordapp.net/stickers/1405546781927936051.png"
                "https://media.discordapp.net/stickers/1405855503858274397.png"
              )
              ;;
            "evening")
              STICKERS=(
                "https://media.discordapp.net/stickers/1405914196922597549.png"
                "https://media.discordapp.net/stickers/1406065324758929509.png"
                "https://media.discordapp.net/stickers/1406629592839491716.png"
              )
              ;;
            "night")
              STICKERS=(
                "https://media.discordapp.net/stickers/1406668584335184003.png"
                "https://media.discordapp.net/stickers/1407858067013369856.png"
                "https://media.discordapp.net/stickers/1407858350334677204.png"
                "https://media.discordapp.net/stickers/1407858765616779396.png"
                "https://media.discordapp.net/stickers/1407859373396590735.png"
              )
              ;;
          esac
          
          RANDOM_INDEX=$((RANDOM % ${#STICKERS[@]}))
          SELECTED_STICKER=${STICKERS[$RANDOM_INDEX]}
          
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               -d "{\"content\":\"$SELECTED_STICKER\"}"
          
          echo "üéâ Sticker sent!"

      - name: Execution Summary
        run: |
          echo "üìä EXECUTION SUMMARY"
          echo "================================"
          echo "üïê Time: ${{ steps.context.outputs.CURRENT_TIME }} WIB (${{ steps.context.outputs.CURRENT_DAY }})"
          echo "üéØ Type: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.CONTEXT }})"
          echo "üå§Ô∏è Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "ü§ñ AI Success: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "üè† OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          echo "üß™ Test Mode: ${{ github.event.inputs.test_mode }}"
          echo "================================"
          echo "‚úÖ Skye community greeting complete!"