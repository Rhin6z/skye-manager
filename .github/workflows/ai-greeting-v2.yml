name: Skye Community AI Greeting

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'Source (openwrt/manual/test)'
        required: false
        default: 'manual'
        type: string
      greeting_type:
        description: 'Greeting type'
        required: false
        default: 'auto'
        type: choice
        options: [auto, morning, afternoon, evening, night]
      force_weather:
        description: 'Force weather check'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Test mode'
        required: false
        default: false
        type: boolean

jobs:
  send-greeting:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    
    steps:
      - name: Setup Context
        id: context
        run: |
          export TZ='Asia/Jakarta'
          
          OPENWRT_MODE=false
          if command -v opkg >/dev/null 2>&1 || [[ -f /etc/openwrt_release ]] || [[ "${{ github.event.inputs.trigger_source }}" == "openwrt" ]]; then
            OPENWRT_MODE=true
            echo "🏠 OpenWrt detected - optimized timing mode"
          fi
          
          CURRENT_DAY=$(date +%A)
          CURRENT_DATE=$(date +"%B %d, %Y")
          CURRENT_TIME=$(date +"%H:%M")
          HOUR=$(date +%H | sed 's/^0*//')
          DAY_NUM=$(date +%u)
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MANUAL_TYPE="${{ github.event.inputs.greeting_type }}"
            if [[ "$MANUAL_TYPE" == "auto" ]]; then
              if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
                TYPE="morning"
              elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
                TYPE="afternoon" 
              elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
                TYPE="evening"
              else
                TYPE="night"
              fi
            else
              TYPE="$MANUAL_TYPE"
            fi
          else
            if [[ $HOUR -ge 5 && $HOUR -lt 12 ]]; then
              TYPE="morning"
            elif [[ $HOUR -ge 12 && $HOUR -lt 17 ]]; then
              TYPE="afternoon" 
            elif [[ $HOUR -ge 17 && $HOUR -lt 21 ]]; then
              TYPE="evening"
            else
              TYPE="night"
            fi
          fi
          
          if [[ $DAY_NUM -eq 6 || $DAY_NUM -eq 7 ]]; then
            CONTEXT="weekend"
          else
            CONTEXT="weekday"
          fi
          
          SPECIAL_CONTEXT=""
          case "$CURRENT_DAY" in
            "Monday") SPECIAL_CONTEXT="monday_motivation" ;;
            "Wednesday") SPECIAL_CONTEXT="hump_day" ;;
            "Friday") SPECIAL_CONTEXT="weekend_countdown" ;;
            "Sunday") SPECIAL_CONTEXT="sunday_prep" ;;
          esac
          
          echo "TYPE=$TYPE" >> $GITHUB_OUTPUT
          echo "CONTEXT=$CONTEXT" >> $GITHUB_OUTPUT
          echo "CURRENT_DAY=$CURRENT_DAY" >> $GITHUB_OUTPUT
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "SPECIAL_CONTEXT=$SPECIAL_CONTEXT" >> $GITHUB_OUTPUT
          echo "DAY_NUM=$DAY_NUM" >> $GITHUB_OUTPUT
          echo "OPENWRT_MODE=$OPENWRT_MODE" >> $GITHUB_OUTPUT
          
          echo "🎯 Context: $TYPE on $CURRENT_DAY ($SPECIAL_CONTEXT)"

      - name: Get Weather (BMKG Yogyakarta)
        id: weather
        run: |
          WEATHER_INFO=""
          echo "🌤️ Fetching BMKG weather for Yogyakarta..."
          
          BMKG_RAW=$(curl -s "https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=34.04.07.2001" --connect-timeout 8 --max-time 15 || echo "")
            
          if [[ -n "$BMKG_RAW" && "$BMKG_RAW" != *"error"* && "$BMKG_RAW" != *"Error"* ]]; then
            echo "✅ BMKG API response received"
            
            TEMP=$(echo "$BMKG_RAW" | grep -o '"t":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            DESC=$(echo "$BMKG_RAW" | grep -o '"weather_desc":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [[ -n "$TEMP" || -n "$DESC" ]]; then
              echo "🌡️ Raw: $TEMP°C | $DESC"
              
              WEATHER_CASUAL=""
              if [[ -n "$DESC" ]]; then
                DESC_LOWER=$(echo "$DESC" | tr '[:upper:]' '[:lower:]')
                
                if [[ "$DESC_LOWER" == *"hujan"* || "$DESC_LOWER" == *"rain"* ]]; then
                  WEATHER_CASUAL="hujan"
                elif [[ "$DESC_LOWER" == *"gerimis"* || "$DESC_LOWER" == *"drizzle"* ]]; then
                  WEATHER_CASUAL="gerimis"
                elif [[ "$DESC_LOWER" == *"panas"* || "$DESC_LOWER" == *"hot"* || "$DESC_LOWER" == *"terik"* ]]; then
                  WEATHER_CASUAL="panas"
                elif [[ "$DESC_LOWER" == *"dingin"* || "$DESC_LOWER" == *"cold"* ]]; then
                  WEATHER_CASUAL="dingin"
                elif [[ "$DESC_LOWER" == *"sejuk"* || "$DESC_LOWER" == *"cool"* || "$DESC_LOWER" == *"adem"* ]]; then
                  WEATHER_CASUAL="sejuk"
                elif [[ "$DESC_LOWER" == *"berawan"* || "$DESC_LOWER" == *"cloudy"* ]]; then
                  WEATHER_CASUAL="berawan"
                elif [[ "$DESC_LOWER" == *"cerah"* || "$DESC_LOWER" == *"sunny"* || "$DESC_LOWER" == *"clear"* ]]; then
                  WEATHER_CASUAL="cerah"
                else
                  WEATHER_CASUAL="enak"
                fi
              fi
              
              if [[ -n "$TEMP" && -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL} ${TEMP}°c"
              elif [[ -n "$WEATHER_CASUAL" ]]; then
                WEATHER_INFO="cuaca ${WEATHER_CASUAL}"
              elif [[ -n "$TEMP" ]]; then
                WEATHER_INFO="${TEMP}°c"
              fi
              
              echo "✅ BMKG Weather: $WEATHER_INFO"
            else
              echo "⚠️ Could not extract weather data from BMKG response"
              WEATHER_INFO="cuaca enak"
            fi
          else
            echo "❌ BMKG API failed, using fallback"
            WEATHER_INFO="cuaca enak"
          fi
          
          # Define weather-appropriate emojis for later use
          WEATHER_EMOJI=""
          if [[ "$WEATHER_INFO" == *"hujan"* ]]; then
            WEATHER_EMOJI="🌧️"
          elif [[ "$WEATHER_INFO" == *"gerimis"* ]]; then
            WEATHER_EMOJI="🌦️"
          elif [[ "$WEATHER_INFO" == *"panas"* ]]; then
            WEATHER_EMOJI="🔥"
          elif [[ "$WEATHER_INFO" == *"dingin"* ]]; then
            WEATHER_EMOJI="❄️"
          elif [[ "$WEATHER_INFO" == *"sejuk"* ]]; then
            WEATHER_EMOJI="🍃"
          elif [[ "$WEATHER_INFO" == *"berawan"* ]]; then
            WEATHER_EMOJI="☁️"
          elif [[ "$WEATHER_INFO" == *"cerah"* ]]; then
            WEATHER_EMOJI="☀️"
          else
            WEATHER_EMOJI="🌤️"
          fi
          
          echo "WEATHER_INFO=$WEATHER_INFO" >> $GITHUB_OUTPUT
          echo "WEATHER_EMOJI=$WEATHER_EMOJI" >> $GITHUB_OUTPUT

      - name: Generate AI Greeting
        id: ai_generation
        run: |
          echo "🤖 Generating AI greeting..."
          
          # Create special context prompt addition if applicable
          SPECIAL_PROMPT=""
          if [[ -n "${{ steps.context.outputs.SPECIAL_CONTEXT }}" ]]; then
            case "${{ steps.context.outputs.SPECIAL_CONTEXT }}" in
              "monday_motivation")
                SPECIAL_PROMPT="Include motivation for the week ahead or Monday energy vibes"
                ;;
              "hump_day")
                SPECIAL_PROMPT="Mention mid-week energy or halfway to weekend vibes"
                ;;
              "weekend_countdown")
                SPECIAL_PROMPT="Celebrate approaching weekend or Friday feeling"
                ;;
              "sunday_prep")
                SPECIAL_PROMPT="Reference preparing for the week ahead or enjoying the last of weekend"
                ;;
            esac
          fi
          
          # Get weather emoji for appropriate matching
          WEATHER_EMOJI="${{ steps.weather.outputs.WEATHER_EMOJI }}"
          
          # Create a much simpler, more structured prompt
          cat > /tmp/prompt.txt << EOF
          You're a hype admin for an Indonesian gaming Discord server called "Skye".
          
          Generate a greeting with EXACTLY these two parts, separated by a space:
          
          PART 1: English greeting that starts with "yoooow" or "wassuuup" or "heyyyyyy" or "suuuup" or "oiiiii" or "ayooooo" or "yoohoooo", asks a question about gaming/activities on ${{ steps.context.outputs.CURRENT_DAY }} (${{ steps.context.outputs.TYPE }}), and ends with a question mark.
          
          PART 2: Indonesian invitation that starts with "yuuuk" or "gaskeun" or "gas polll" or "ayooook" or "hayuuuk" or "pada mauuu gak" or "siapaaaa yang mau", suggests a gaming activity appropriate for ${{ steps.context.outputs.TYPE }} and ${{ steps.weather.outputs.WEATHER_INFO }}, mentions the weather ("cuaca") directly, and ends with $WEATHER_EMOJI or 🎮.
          
          ${SPECIAL_PROMPT}
          
          If it's a weekend (${{ steps.context.outputs.CONTEXT }} == "weekend"), include this tag in part 2: <@&1374047008829997157>
          
          Keep everything lowercase. Make it sound like a real hyped-up gamer.
          
          DO NOT OMIT PART 2. You MUST write both parts.
          
          EXAMPLES:
          yoooow morning squad, coffee or controller which quest are you tackling this wednesday? yuuuk ngopi dulu sambil warm up aim, cuaca cerah bikin fokus jadi perfect buat daily quest 🎮
          
          heyyyyyy afternoon crew, post lunch energy hitting different or still food coma mode? gaskeun quick match ml sambil ngadem, cuaca panas bikin mager jadi mending ranked push di AC 🔥
          EOF
          
          # Make 3 attempts to get a valid response
          MAX_ATTEMPTS=3
          ATTEMPT=1
          USE_AI=false
          
          while [[ $ATTEMPT -le $MAX_ATTEMPTS && "$USE_AI" != "true" ]]; do
            echo "🔄 AI generation attempt $ATTEMPT of $MAX_ATTEMPTS"
            
            python3 << 'PYTHON_EOF'
            import json
            import requests
            import os
            import sys
            import re
            
            try:
                with open('/tmp/prompt.txt', 'r') as f:
                    prompt = f.read().strip()
                
                api_key = os.environ.get('GEMINI_API_KEY')
                if not api_key:
                    print("❌ No API key")
                    sys.exit(1)
                
                url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key={api_key}"
                
                payload = {
                    "contents": [{"parts": [{"text": prompt}]}],
                    "generationConfig": {
                        "temperature": 0.4,  # Lower temperature for more deterministic output
                        "maxOutputTokens": 200,
                        "topP": 0.95,
                        "topK": 40
                    }
                }
                
                response = requests.post(url, json=payload, timeout=20)
                
                if response.status_code == 200:
                    data = response.json()
                    if 'candidates' in data and len(data['candidates']) > 0:
                        ai_text = data['candidates'][0]['content']['parts'][0]['text'].strip()
                        
                        # Clean formatting and remove any line breaks
                        clean_text = re.sub(r'\*\*([^*]+)\*\*', r'\1', ai_text)
                        clean_text = re.sub(r'`([^`]+)`', r'\1', clean_text)
                        clean_text = re.sub(r'\n+', ' ', clean_text)
                        clean_text = ' '.join(clean_text.split())
                        
                        # Extract only the actual greeting (not explanations)
                        lines = [line.strip() for line in ai_text.split('\n') if line.strip()]
                        best_line = ""
                        
                        for line in lines:
                            if ('?' in line and 
                                (line.startswith('yooo') or 
                                 line.startswith('wassup') or 
                                 line.startswith('heyyy') or 
                                 line.startswith('sup') or 
                                 line.startswith('oi') or 
                                 line.startswith('ayo') or
                                 line.startswith('hello'))):
                                best_line = line
                                break
                        
                        if not best_line:
                            best_line = clean_text
                        
                        with open('/tmp/ai_response.txt', 'w', encoding='utf-8') as f:
                            f.write(best_line)
                        print("✅ AI generation successful")
                        sys.exit(0)
                
                print("❌ AI generation failed - invalid response")
                sys.exit(1)
                
            except Exception as e:
                print(f"❌ AI generation failed: {e}")
                sys.exit(1)
            PYTHON_EOF
            
            if [[ $? -eq 0 && -s /tmp/ai_response.txt ]]; then
              AI_TEXT=$(cat /tmp/ai_response.txt)
              echo "🎯 AI generated: $AI_TEXT"
              
              # Try to automatically fix single-sentence responses by adding a second part
              if [[ ! "$AI_TEXT" =~ "yuk" && ! "$AI_TEXT" =~ "gas" && ! "$AI_TEXT" =~ "ayo" ]]; then
                echo "⚠️ Missing Indonesian part, attempting to fix..."
                
                # Create appropriate second sentence based on context
                if [[ "${{ steps.context.outputs.CONTEXT }}" == "weekend" ]]; then
                  SECOND_PART=""
                  case "${{ steps.context.outputs.TYPE }}" in
                    "morning")
                      SECOND_PART="yuuuk <@&1374047008829997157> ngopi sambil warm up aim dulu, ${{ steps.weather.outputs.WEATHER_INFO }} perfect buat fokus grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                    "afternoon")
                      SECOND_PART="gaskeun <@&1374047008829997157> quick match sambil santai, ${{ steps.weather.outputs.WEATHER_INFO }} pas buat chill gaming! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                    "evening")
                      SECOND_PART="gas polll <@&1374047008829997157> mabar sambil makan malam, ${{ steps.weather.outputs.WEATHER_INFO }} bikin mood relaxing! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                    "night")
                      SECOND_PART="hayuuuk <@&1374047008829997157> push rank marathon sampe pagi, ${{ steps.weather.outputs.WEATHER_INFO }} enak buat grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                  esac
                else
                  SECOND_PART=""
                  case "${{ steps.context.outputs.TYPE }}" in
                    "morning")
                      SECOND_PART="yuuuk ngopi sambil warm up aim dulu, ${{ steps.weather.outputs.WEATHER_INFO }} perfect buat fokus grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                    "afternoon")
                      SECOND_PART="gaskeun quick match sambil santai, ${{ steps.weather.outputs.WEATHER_INFO }} pas buat chill gaming! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                    "evening")
                      SECOND_PART="gas polll mabar sambil makan malam, ${{ steps.weather.outputs.WEATHER_INFO }} bikin mood relaxing! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                    "night")
                      SECOND_PART="hayuuuk push rank marathon sampe pagi, ${{ steps.weather.outputs.WEATHER_INFO }} enak buat grinding! ${{ steps.weather.outputs.WEATHER_EMOJI }}"
                      ;;
                  esac
                fi
                
                # Add second part if the AI only generated the first part
                if [[ "$AI_TEXT" =~ \? ]]; then
                  AI_TEXT="$AI_TEXT $SECOND_PART"
                  echo "✅ Fixed by adding second part: $AI_TEXT"
                fi
              fi
              
              # Simplified validation focusing on key elements
              HAS_ENGLISH_PART=$(echo "$AI_TEXT" | grep -E "\?" || echo "")
              HAS_INDONESIAN_PART=$(echo "$AI_TEXT" | grep -E "(yuk|gas|ayo|hayuk|siapa)" || echo "")
              HAS_WEATHER=$(echo "$AI_TEXT" | grep -E "(cuaca|hujan|cerah|panas|dingin|sejuk|berawan)" || echo "")
              
              if [[ -n "$HAS_ENGLISH_PART" && -n "$HAS_INDONESIAN_PART" && -n "$HAS_WEATHER" && ${#AI_TEXT} -gt 60 ]]; then
                DESC_RAW="$AI_TEXT"
                USE_AI=true
                echo "✅ AI validation passed"
              else
                echo "⚠️ AI validation failed"
                echo "   English part: ${HAS_ENGLISH_PART:-missing}"
                echo "   Indonesian part: ${HAS_INDONESIAN_PART:-missing}" 
                echo "   Weather: ${HAS_WEATHER:-missing}"
                echo "   Length: ${#AI_TEXT} chars"
              fi
            else
              echo "❌ AI generation attempt failed"
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          if [[ "$USE_AI" != "true" ]]; then
            echo "🎲 Using fallback system..."
            
            WEATHER_MENTION="${{ steps.weather.outputs.WEATHER_INFO }}"
            WEATHER_EMOJI="${{ steps.weather.outputs.WEATHER_EMOJI }}"
            declare -a MESSAGES
            
            # Improved fallback messages with correct weather emoji matching
            case "${{ steps.context.outputs.TYPE }}" in
              "morning")
                MESSAGES=(
                  "yoooow morning squad, coffee hitting different or controller calling your name already? yuuuk <@&1374047008829997157> ngopi sambil warm up aim dulu, ${WEATHER_MENTION} perfect buat fokus grinding! ${WEATHER_EMOJI}"
                  "wassuuuup early birds, energy level udah full atau masih butuh caffeine boost? gaskeun <@&1374047008829997157> sarapan sambil daily quest ringan, ${WEATHER_MENTION} bikin mood enak buat main! 🎮"
                  "heyyyyyy morning legends, dreams about ranked or nightmares about losing streak? ayooook <@&1374047008829997157> stretching dulu terus langsung gaming, ${WEATHER_MENTION} cocok banget! ${WEATHER_EMOJI}"
                  "oiiiii morning crew, ready to conquer today atau masih half asleep mode? gas polll <@&1374047008829997157> planning strategy sambil ngopi, ${WEATHER_MENTION} enak nih! 🎮"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow morning squad, coffee hitting different or controller calling your name already? yuuuk ngopi sambil warm up aim dulu, ${WEATHER_MENTION} perfect buat fokus grinding! ${WEATHER_EMOJI}"
                    "wassuuuup early birds, energy level udah full atau masih butuh caffeine boost? gaskeun sarapan sambil daily quest ringan, ${WEATHER_MENTION} bikin mood enak buat main! 🎮"
                    "heyyyyyy morning legends, dreams about ranked or nightmares about losing streak? ayooook stretching dulu terus langsung gaming, ${WEATHER_MENTION} cocok banget! ${WEATHER_EMOJI}"
                    "oiiiii morning crew, ready to conquer today atau masih half asleep mode? gas polll planning strategy sambil ngopi, ${WEATHER_MENTION} enak nih! 🎮"
                  )
                fi
                ;;
              "afternoon")
                MESSAGES=(
                  "yoooow afternoon vibes, lunch coma hitting atau energy masih tinggi banget? yuuuk <@&1374047008829997157> quick match ml sambil digest, ${WEATHER_MENTION} pas buat santai gaming! ${WEATHER_EMOJI}"
                  "wassuuuup midday squad, productivity tinggi atau udah mulai burnout? pada mauuu gak <@&1374047008829997157> aram party sambil ngobrol, ${WEATHER_MENTION} bikin pengen ngadem! ${WEATHER_EMOJI}"
                  "heyyyyyy afternoon crew, grind mode on atau break time calling? gaskeun <@&1374047008829997157> push rank valo sambil makan siang, ${WEATHER_MENTION} enak banget! 🎮"
                  "suuuup afternoon legends, motivation still high atau udah weekend mode? siapaaaa yang mau <@&1374047008829997157> roblox party sambil chill, ${WEATHER_MENTION} perfect timing! 🎮"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow afternoon vibes, lunch coma hitting atau energy masih tinggi banget? yuuuk quick match ml sambil digest, ${WEATHER_MENTION} pas buat santai gaming! ${WEATHER_EMOJI}"
                    "wassuuuup midday squad, productivity tinggi atau udah mulai burnout? pada mauuu gak aram party sambil ngobrol, ${WEATHER_MENTION} bikin pengen ngadem! ${WEATHER_EMOJI}"
                    "heyyyyyy afternoon crew, grind mode on atau break time calling? gaskeun push rank valo sambil makan siang, ${WEATHER_MENTION} enak banget! 🎮"
                    "suuuup afternoon legends, motivation still high atau udah weekend mode? siapaaaa yang mau roblox party sambil chill, ${WEATHER_MENTION} perfect timing! 🎮"
                  )
                fi
                ;;
              "evening")
                MESSAGES=(
                  "yoooow evening squad, day was productive atau disaster yang indah? gas polll <@&1374047008829997157> dinner sambil voice chat, ${WEATHER_MENTION} bikin mood relaxing! ${WEATHER_EMOJI}"
                  "wassuuuup golden hour gang, winding down atau masih full energy? yuuuk <@&1374047008829997157> mabar ml sambil sunset vibes, ${WEATHER_MENTION} aesthetic banget! 🎮"
                  "heyyyyyy evening crew, tired dari seharian atau ready for night session? hayuuuk <@&1374047008829997157> push rank sambil makan malam, ${WEATHER_MENTION} pas! ${WEATHER_EMOJI}"
                  "ayooooo evening legends, chores done atau masih ada PR hidup? pada mauuu gak <@&1374047008829997157> gaming marathon prep, ${WEATHER_MENTION} cocok buat focus! 🎮"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow evening squad, day was productive atau disaster yang indah? gas polll dinner sambil voice chat, ${WEATHER_MENTION} bikin mood relaxing! ${WEATHER_EMOJI}"
                    "wassuuuup golden hour gang, winding down atau masih full energy? yuuuk mabar ml sambil sunset vibes, ${WEATHER_MENTION} aesthetic banget! 🎮"
                    "heyyyyyy evening crew, tired dari seharian atau ready for night session? hayuuuk push rank sambil makan malam, ${WEATHER_MENTION} pas! ${WEATHER_EMOJI}"
                    "ayooooo evening legends, chores done atau masih ada PR hidup? pada mauuu gak gaming marathon prep, ${WEATHER_MENTION} cocok buat focus! 🎮"
                  )
                fi
                ;;
              "night")
                MESSAGES=(
                  "yoooow night owls, insomnia squad atau pilihan begadang for fun? yuuuk <@&1374047008829997157> marathon gaming sambil vibing, ${WEATHER_MENTION} enak buat late night session! ${WEATHER_EMOJI}"
                  "wassuuuup midnight legends, peaceful hours atau chaos di ranked? siapaaaa yang mau <@&1374047008829997157> grind sampai pagi sambil ngobrol, ${WEATHER_MENTION} bikin betah! 🎮"
                  "heyyyyyy nocturnal gamers, night hits different atau sama aja? gaskeun <@&1374047008829997157> push rank ml sampai subuh, ${WEATHER_MENTION} perfect buat focus! ${WEATHER_EMOJI}"
                  "suuuup late night squad, bocil udah tidur semua nih freedom time! hayuuuk <@&1374047008829997157> party games sambil ketawa, ${WEATHER_MENTION} cocok buat chill! 🎮"
                )
                if [[ "${{ steps.context.outputs.CONTEXT }}" != "weekend" ]]; then
                  MESSAGES=(
                    "yoooow night owls, insomnia squad atau pilihan begadang for fun? yuuuk marathon gaming sambil vibing, ${WEATHER_MENTION} enak buat late night session! ${WEATHER_EMOJI}"
                    "wassuuuup midnight legends, peaceful hours atau chaos di ranked? siapaaaa yang mau grind sampai pagi sambil ngobrol, ${WEATHER_MENTION} bikin betah! 🎮"
                    "heyyyyyy nocturnal gamers, night hits different atau sama aja? gaskeun push rank ml sampai subuh, ${WEATHER_MENTION} perfect buat focus! ${WEATHER_EMOJI}"
                    "suuuup late night squad, bocil udah tidur semua nih freedom time! hayuuuk party games sambil ketawa, ${WEATHER_MENTION} cocok buat chill! 🎮"
                  )
                fi
                ;;
            esac
            
            # Add special context messages with day-specific references
            if [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "monday_motivation" ]]; then
              MESSAGES+=(
                "yoooow monday warriors, ready to conquer the week or still in weekend mode? yuuuk start dengan semangat sambil gaming, ${WEATHER_MENTION} cocok buat fresh start minggu ini! ${WEATHER_EMOJI}"
              )
            elif [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "hump_day" ]]; then
              MESSAGES+=(
                "wassuuuup wednesday crew, halfway to weekend vibes mulai kerasa? gas polll mid-week gaming session buat recharge, ${WEATHER_MENTION} pas banget buat midweek boost rabu ini! ${WEATHER_EMOJI}"
              )
            elif [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "weekend_countdown" ]]; then
              MESSAGES+=(
                "heyyyyyy friday squad, weekend energy udah mulai muncul? siapaaaa yang mau start weekend dengan victory streak, ${WEATHER_MENTION} perfect buat weekend countdown jumat ini! ${WEATHER_EMOJI}"
              )
            elif [[ "${{ steps.context.outputs.SPECIAL_CONTEXT }}" == "sunday_prep" ]]; then
              MESSAGES+=(
                "oiiiii sunday gamers, enjoying the last bits of weekend freedom? yuuuk maximal weekend fun sebelum monday, ${WEATHER_MENTION} bikin betah buat last day grinding minggu ini! ${WEATHER_EMOJI}"
              )
            fi
            
            RANDOM_INDEX=$((RANDOM % ${#MESSAGES[@]}))
            DESC_RAW="${MESSAGES[$RANDOM_INDEX]}"
          fi
          
          declare -a TITLES
          declare -a THUMBS
          
          # Match thumbnail to weather when possible
          case "${{ steps.context.outputs.TYPE }}" in
            "morning") 
              if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
                TITLES=("☔ Rainy Morning Vibes" "🌧️ Cozy Morning Gaming" "☕ Coffee & Rain Sounds" "🌧️ Fresh Morning Grind" "⛈️ Rainy Day Gaming")
                THUMBS=("2614" "1f327" "2615" "1f327" "26c8")
              elif [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"panas"* ]]; then
                TITLES=("🔥 Hot Morning Grind" "☀️ Sunny Morning Energy" "☕ Coffee & Sunshine" "🌞 Fresh Morning Heat" "⭐ Hot Day Ahead")
                THUMBS=("1f525" "2600" "2615" "1f31e" "2b50")
              else
                TITLES=("☀️ Morning Skye Squad" "🌅 Early Bird Energy" "☕ Coffee & Gaming Time" "🌞 Fresh Morning Vibes" "⭐ New Day New Games")
                THUMBS=("2600" "1f305" "2615" "1f31e" "2b50")
              fi
              ;;
            "afternoon") 
              if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
                TITLES=("🌧️ Rainy Afternoon Chill" "☔ Midday Rain Gaming" "🌦️ Lunch & Rain Vibes" "🎯 Rainy Focus Time" "💼 Indoor Gaming Break")
                THUMBS=("1f327" "2614" "1f326" "1f3af" "1f4bc")
              else
                TITLES=("🍃 Afternoon Chill Mode" "🌤️ Midday Squad Check" "☀️ Lunch Break Gaming" "🎯 Afternoon Focus Time" "💼 Productive Break")
                THUMBS=("1f343" "1f324" "2600" "1f3af" "1f4bc")
              fi
              ;;
            "evening") 
              if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
                TITLES=("🌧️ Rainy Evening Chill" "🌆 Sunset Rain Gaming" "✨ Cozy Evening Vibes" "☔ Rainy Gaming Time" "🎯 Evening Storm Mode")
                THUMBS=("1f327" "1f306" "2728" "2614" "1f3af")
              else
                TITLES=("🌇 Evening Chill Squad" "🌆 Golden Hour Gaming" "✨ Evening Wind-Down" "🌅 Sunset Gaming Time" "🎯 Evening Focus Mode")
                THUMBS=("1f307" "1f306" "2728" "1f305" "1f3af")
              fi
              ;;
            "night") 
              if [[ "${{ steps.weather.outputs.WEATHER_INFO }}" == *"hujan"* ]]; then
                TITLES=("🌧️ Rainy Night Gaming" "🌙 Midnight Rain Club" "⭐ Stormy Night Session" "✨ Rain & Games Combo" "🌟 Rainy Night Energy")
                THUMBS=("1f327" "1f319" "2b50" "2728" "1f31f")
              else
                TITLES=("🦉 Late Night Squad" "🌙 Midnight Gaming Club" "⭐ Night Owl Assembly" "✨ Nocturnal Gamers" "🌟 Late Night Energy")
                THUMBS=("1f989" "1f319" "2b50" "2728" "1f31f")
              fi
              ;;
          esac
          
          RANDOM_INDEX=$((RANDOM % ${#TITLES[@]}))
          TITLE="${TITLES[$RANDOM_INDEX]}"
          THUMB="${THUMBS[$RANDOM_INDEX]}"
          
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "DESC_RAW=$DESC_RAW" >> $GITHUB_OUTPUT
          echo "USE_AI=$USE_AI" >> $GITHUB_OUTPUT
          echo "THUMB=$THUMB" >> $GITHUB_OUTPUT
          
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Send Discord Message
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "📤 Sending Discord message..."
          
          case "${{ steps.context.outputs.TYPE }}" in
            "morning") COLOR=16766720 ;;
            "afternoon") COLOR=16763904 ;;
            "evening") COLOR=16744448 ;;
            "night") COLOR=8947848 ;;
          esac
          
          TITLE="${{ steps.ai_generation.outputs.TITLE }}"
          DESC="${{ steps.ai_generation.outputs.DESC_RAW }}"
          THUMB="${{ steps.ai_generation.outputs.THUMB }}"
          TIMESTAMP=$(TZ='Asia/Jakarta' date -u +%Y-%m-%dT%H:%M:%S.000Z)
          
          python3 << 'PYTHON_EOF'
          import json
          import os
          
          title = os.environ.get('TITLE', 'Skye Squad')
          desc_raw = os.environ.get('DESC', 'what\'s good everyone!')
          color = int(os.environ.get('COLOR', '16766720'))
          timestamp = os.environ.get('TIMESTAMP', '')
          thumb = os.environ.get('THUMB', '1f305')
          context = os.environ.get('CONTEXT', 'weekday')
          
          # Convert description to lowercase
          desc = desc_raw.lower()
          
          # Add signature
          desc += "\n> by server dev guanteng - <@399393175904714752>"
          
          embed = {
              "title": title,
              "description": desc,
              "color": color,
              "thumbnail": {
                  "url": f"https://twemoji.maxcdn.com/v/latest/72x72/{thumb}.png"
              },
              "footer": {
                  "text": "chill gaming vibes",
                  "icon_url": "https://files.catbox.moe/npfh4e.jpg"
              },
              "timestamp": timestamp
          }
          
          payload = {"embeds": [embed]}
          
          with open('/tmp/discord_payload.json', 'w', encoding='utf-8') as f:
              json.dump(payload, f, ensure_ascii=False)
          
          print("✅ Payload created")
          PYTHON_EOF
          
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               --data-binary @/tmp/discord_payload.json
          
          echo "✅ Message sent!"
          echo "🤖 AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"
          
        env:
          TITLE: ${{ steps.ai_generation.outputs.TITLE }}
          DESC: ${{ steps.ai_generation.outputs.DESC_RAW }}
          COLOR: ${{ env.COLOR }}
          TIMESTAMP: ${{ env.TIMESTAMP }}
          THUMB: ${{ steps.ai_generation.outputs.THUMB }}
          CONTEXT: ${{ steps.context.outputs.CONTEXT }}

      - name: Test Mode Output
        if: ${{ github.event.inputs.test_mode == 'true' }}
        run: |
          echo "🧪 TEST MODE - Message preview:"
          echo "================================"
          echo "Title: ${{ steps.ai_generation.outputs.TITLE }}"
          echo "Description: ${{ steps.ai_generation.outputs.DESC_RAW }}"
          echo "AI Used: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "Context: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.SPECIAL_CONTEXT }})"
          echo "OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          echo "================================"
          echo "🧪 Test complete - no message sent"

      - name: Send Random Sticker
        if: ${{ github.event.inputs.test_mode != 'true' }}
        run: |
          echo "🎲 Sending random sticker..."
          
          if [[ "${{ steps.context.outputs.OPENWRT_MODE }}" == "true" ]]; then
            echo "🏠 OpenWrt mode - sending sticker immediately"
            sleep 1
          else
            echo "⏰ Standard delay for sticker..."
            sleep 3
          fi
          
          case "${{ steps.context.outputs.TYPE }}" in
            "morning")
              STICKERS=(
                "https://media.discordapp.net/stickers/1404543938815197306.png"
                "https://media.discordapp.net/stickers/1405277985237368943.png"
                "https://media.discordapp.net/stickers/1405477154095104082.png"
              )
              ;;
            "afternoon")
              STICKERS=(
                "https://media.discordapp.net/stickers/1405487683526201404.png"
                "https://media.discordapp.net/stickers/1405546781927936051.png"
                "https://media.discordapp.net/stickers/1405855503858274397.png"
              )
              ;;
            "evening")
              STICKERS=(
                "https://media.discordapp.net/stickers/1405914196922597549.png"
                "https://media.discordapp.net/stickers/1406065324758929509.png"
                "https://media.discordapp.net/stickers/1406629592839491716.png"
              )
              ;;
            "night")
              STICKERS=(
                "https://media.discordapp.net/stickers/1406668584335184003.png"
                "https://media.discordapp.net/stickers/1407858067013369856.png"
                "https://media.discordapp.net/stickers/1407858350334677204.png"
                "https://media.discordapp.net/stickers/1407858765616779396.png"
                "https://media.discordapp.net/stickers/1407859373396590735.png"
              )
              ;;
          esac
          
          RANDOM_INDEX=$((RANDOM % ${#STICKERS[@]}))
          SELECTED_STICKER=${STICKERS[$RANDOM_INDEX]}
          
          curl -f -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               -d "{\"content\":\"$SELECTED_STICKER\"}"
          
          echo "🎉 Sticker sent!"

      - name: Execution Summary
        run: |
          echo "📊 EXECUTION SUMMARY"
          echo "================================"
          echo "🕐 Time: ${{ steps.context.outputs.CURRENT_TIME }} WIB (${{ steps.context.outputs.CURRENT_DAY }})"
          echo "🎯 Type: ${{ steps.context.outputs.TYPE }} (${{ steps.context.outputs.CONTEXT }})"
          echo "🌤️ Weather: ${{ steps.weather.outputs.WEATHER_INFO }}"
          echo "🤖 AI Success: ${{ steps.ai_generation.outputs.USE_AI }}"
          echo "🏠 OpenWrt Mode: ${{ steps.context.outputs.OPENWRT_MODE }}"
          echo "🧪 Test Mode: ${{ github.event.inputs.test_mode }}"
          echo "================================"
          echo "✅ Skye community greeting complete!"